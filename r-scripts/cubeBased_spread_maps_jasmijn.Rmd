```{r libraries}
library(sf)
library(leaflet)
library(tidyverse)
library(dplyr)
```

```{r get species list}
species_list <- read.csv("./data/input/prius_species_list.csv") 
```

```{r get shapes}
vla_1km <- st_read("./data/spatial/grids/vla_1km.geojson")
Vlaanderen_grenzen <- st_read("./data/spatial/flanders_wgs84.geojson")
#Vlaanderen_grenzen <- st_transform(Vlaanderen_grenzen, crs=st_crs(vla_1km))
#st_write(Vlaanderen_grenzen,  "./data/spatial/flanders_wgs84.geojson")
```

```{r get cube data}
IAS_Cube <- read_csv(file = "https://zenodo.org/record/4299976/files/be_alientaxa_cube.csv?download=1") %>% 
  filter(year >= 2015) %>% 
  filter(taxonKey %in% species_list$GBIF_code) %>% 
  filter(eea_cell_code %in% vla_1km$CELLCODE)
```

```{r test data completeness}
IAS_Cube_summarise <- IAS_Cube %>% 
  group_by(taxonKey) %>% 
  summarise(n_tot = sum(n, na.rm = TRUE))

not_in_cube <- species_list %>% 
  left_join(IAS_Cube_summarise, by = c("GBIF_code" = "taxonKey")) %>% 
  filter(is.na(n_tot))

write_csv(not_in_cube, "./data/intermediate/taxonkeys_not_in_cube_jas.csv")

in_cube <- species_list %>% 
  left_join(IAS_Cube_summarise, by = c("GBIF_code" = "taxonKey")) %>% 
  filter(!is.na(n_tot))


```

```{r merge data with shapes}
IAS_Cube_1km <- sp::merge(vla_1km, 
                          IAS_Cube,
                          by.x = "CELLCODE",
                          by.y = "eea_cell_code",
                          duplicateGeoms = TRUE)

IAS_Cube_1km <- subset(IAS_Cube_1km, !is.na(IAS_Cube_1km@data$taxonKey))

nrow(IAS_Cube) == nrow(IAS_Cube_1km@data)

```

```{r}
for (species_name in unique(in_cube$Soort)){
  print(species_name)
  GBIF_codes<- in_cube[which(in_cube$Soort==species_name),]$GBIF_code
  print(GBIF_codes)
  IAS_Cube_temp <- IAS_Cube %>%
    filter(taxonKey %in% GBIF_codes)
  print(IAS_Cube_temp)
  IAS_Cube_1km_spec <- merge(vla_1km,
                      IAS_Cube_temp,
                      by.x='CELLCODE',
                      by.y='eea_cell_code',
                      all.y=TRUE)
   a<- ggplot() +
  geom_sf(data = Vlaanderen_grenzen) +
  theme_void() + # Zonder "assen" (coÃ¶rdinaten)
  theme(legend.position="bottom", legend.title = element_blank()) +
  coord_sf()
}
```


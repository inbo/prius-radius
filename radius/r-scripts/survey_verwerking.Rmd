
```{r clear-memory}
rm(list=ls())
```

```{r load-library, message=FALSE}
library(tidyverse)
library(googlesheets4)
library(sf)
library(ggplot2)
library(leaflet)
```

```{r resultaten-oost-west, message=FALSE}
data_oost <- read_csv("./radius/data/input/survey/bevraging_oost.csv", name_repair = make.names)
data_west <- read_sheet("https://docs.google.com/spreadsheets/d/12_YYdx6bpXab77QTPwTVE0xcljUVtmUF0HeQ-wbMGZ8/edit", .name_repair = make.names) 
```

```{r anb-boswachters}
# aantal boswachters per beheerregio (oud: op moment van bevraging Niels, 2023: obv contactlijst ANB 2023)
anb_bw_oud <- data.frame(
  Regio = c("Antwerpse kempen", "Brabantse wouden", "Demerland & Zuiderkempen", "Groene Gordels", "Hoge Kempen tot Voeren", "Kust-Westhoek", "Lage tot aan Hoge Kempen", "Taxandria", "Vlaamse Ardennen en Schelde-Leie", "Zandig Vlaanderen"),
  n = c(8,8,8,5,9,7,10,11,5,6)
)

anb_bw_2023 <- readxl::read_excel("./radius/data/input/survey/Contactenlijst BW en RB.xlsx") %>%
  filter(Job == "Boswachter") %>%
  group_by(Regio) %>%
  summarise(n = n()) %>%
  mutate(Regio = replace(Regio, Regio == "Kust-Westhoek", "Kust & Westhoek"),
         Regio = replace(Regio, Regio =="Vlaamse Ardennen en Schelde-Leie", "Vlaamse Ardennen & Schelde-Leie"))
```

```{r shapefile-beheerregios-anb}
# ik heb zelf een shapefile gemaakt in ArcMap met een ruwe omlijning van de 10 anb beheerregio's (voor hulp bij visualisatie van de resultaten)
beheerregios_anb <- st_read("./radius/data/spatial/beheerregios_anb.shp") %>%
  st_transform(4326) 

# centraal punt van de beheerregio polygonen berekenen
beheerregios_centr <- beheerregios_anb %>%
  st_centroid() %>%
  mutate(decimalLongitude = sf::st_coordinates(.)[,1],
         decimalLatitude = sf::st_coordinates(.)[,2]) %>%
  st_drop_geometry() 

# co√∂rdinaten lichtjes aanpassen op basis van voorkeur
beheerregios_centr[2,3] <- 51.0
beheerregios_centr[6,2] <- 2.750334
beheerregios_centr[3,3] <- 51.2
beheerregios_centr[1,3] <- 51.18
beheerregios_centr[8,2] <- 4.6
beheerregios_centr[8,3] <- 50.85

leaflet() %>%
  addTiles(data = "OSM") %>%
  addPolygons(data = beheerregios_anb, label = ~NAAM, color = "black", weight = 2) %>%
  addCircleMarkers(data = beheerregios_centr, lat = ~decimalLatitude, lng = ~decimalLongitude, radius = 5, weight = 1, fillOpacity = 1, label = ~NAAM)
```

```{r responsgraad per regio}
calculate_response <- function(data, join_data) {
  data %>%
    group_by(Uw.beheerregio) %>%
    summarise(deelnemers = n()) %>%
    left_join(join_data, by = c("Uw.beheerregio" = "Regio")) %>%
    mutate(resp_graad = deelnemers/n * 100) %>%
    left_join(beheerregios_centr, by = c("Uw.beheerregio" = "NAAM"))
}

respons_oost <- calculate_response(data_oost, anb_bw_oud)
respons_west <- calculate_response(data_west, anb_bw_2023)

respons <- rbind(respons_oost, respons_west) %>%
  left_join(beheerregios_anb, by = c("Uw.beheerregio" = "NAAM"))

colorMapper <- colorNumeric(palette = "Greens", domain = respons$resp_graad)

leaflet() %>%
  addTiles(data = "OSM") %>%
  addPolygons(data = respons$geometry, 
              color = "black", 
              weight = 2, 
              fillColor = colorMapper(respons$resp_graad), 
              fillOpacity = 0.8, 
              label = paste0(respons$Uw.beheerregio, ": ", respons$deelnemers, " deelnemers")) %>%
  addLegend(position = "topright", 
            pal = colorNumeric(palette = "Greens", domain = respons$resp_graad), 
            values = respons$resp_graad, title = "responsgraad (%)", opacity = 1) 
```

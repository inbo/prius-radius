---
title: "RadIUS - invasieve uitheemse soorten in de Vlaamse natuur"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---


```{r load-library, include=FALSE}
# general
library(tidyverse)
library(fistools)
library(units)

# spatial data packages
library(sf)

# data visualisation
library(ggplot2)
library(ggthemes)
library(plotly)
library(leaflet)
library(kableExtra)
library(flextable)
library(ggtext)
```

```{r clear-memory, include=FALSE}
rm(list=ls())
```

```{r load-data, include=FALSE}
# Species data 
species_list <- read_csv("./radius/data/input/radius_species_list.csv") 
species_abbr <- read_csv2("G:/Mijn Drive/Fleur/RadIUS/RadIUS voorbereiding/species_abbr.csv")

occ_flanders <- read_csv("./radius/data/input/gbif_occ_flanders.csv") %>%
  st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), crs = "+proj=longlat +datum=WGS84")

# VLAANDEREN 
## spatial
Provincies_grenzen <- st_read("./prius/data/spatial/Provincies.geojson") %>%
  st_transform(4326)

Vlaanderen_grenzen <- st_read("./prius/data/spatial/flanders_wgs84.geojson")

## metrics
VL <- read_csv("./radius/data/output/VL.csv")

# HABITATRICHTLIJN
## spatial
### habitatrichtlijnkaart (incl. deelgebieden)
ps_hbtrl_deel <- st_read("./radius/data/spatial/ps_hbtrl_deel.shp")

### habitatrichtlijnkaart (excl. deelgebieden)
ps_hbtrl <- ps_hbtrl_deel %>%
  group_by(gebcode, naam, gebopp_ha) %>%
  summarise(geometry = sf::st_union(geometry)) %>%
  ungroup() %>%
  st_transform(4326) %>%
  st_as_sf()

## metrics
HBTRL <- read_csv("./radius/data/output/HBTRL_long.csv")

HBTRL_spatial <- ps_hbtrl %>%
  right_join(HBTRL, by = c("gebcode" = "gebied"), keep = TRUE)

# VOGELRICHTLIJN
## spatial
ps_vglrl <- st_read("./radius/data/spatial/ps_vglrl.shp") %>%
  mutate(oppervlakte = round(as.numeric(st_area(geometry))/10000, 1))

## metrics
VGLRL <- read_csv("./radius/data/output/VGLRL_long.csv")

VGLRL_spatial <- ps_vglrl %>%
  right_join(VGLRL, by = c("na2000code" = "gebied"), keep = TRUE)

# N2000 HABITATS
## spatial
n2khab <- st_read("./radius/data/spatial/n2khab.shp")

habitats <- read_csv2("./radius/data/input/toewijzing_habitats.csv", col_types = cols(code = col_character()))

n2khab <- n2khab %>%
  left_join(habitats, by = c("type" = "code")) %>%
  transmute(code = type, habitat = name, shortname, oppervlak = area, groep, geometry)

## metrics
N2KHAB <- read_csv("./radius/data/output/N2KHAB_long.csv")

#### Natuurbeheerplannen


#### ANB patrimonium
## spatial
am_patdat <- st_read("./radius/data/spatial/am_patdat.shp")

## metrics
PATDAT <- read_csv("./radius/data/output/PATDAT_long.csv")
PATDAT_wide <- read_csv("./radius/data/output/PATDAT_wide.csv")

TOP3 <- read_csv("./radius/data/output/TOP3.csv")
```

# DATA EXPLORATIE

## sporadische soorten
Sporadische soorten worden hier gedefinieerd als soorten met minder dan 20 waarnemingen sinds 2015. Voor sommige onderdelen van de analyse worden deze soorten buiten beschouwing gelaten, omdat hun sporadische aanwezigheid te gevoelig is voor extreme resultaten.

```{r spor-species, echo=FALSE}
spor_species <- occ_flanders %>%
  group_by(Soort) %>%
  summarise(n_obs = n()) %>%
  arrange(n_obs) %>%
  filter(n_obs < 20) %>%
  st_drop_geometry()

kable(spor_species, col.names = c("Soort", "Aantal observaties (sinds 2015)"), 
      align = "llr",
      caption = "Sporadische soorten", 
      booktabs = TRUE) %>%
  kable_styling(bootstrap_options = "responsive",
                position = "center",
                font_size = 12,
                htmltable_class = "lightable-classic")
```

# VLAANDEREN

## Welke soorten zijn het meest aanwezig in Vlaanderen? 

Weergave van ofVL-metric (percentage van totale oppervlakte van Vlaanderen dat bezet is door een soort) per soort
```{r occupancy-in-flanders, echo=FALSE}
ggplotly(
  ggplot(data = VL, aes(x = reorder(Soort, ofVL), y = ofVL, text = paste0(Soort, "<br>Aandeel van Vlaanderen: ", round(ofVL * 100, 6), "%"))) +
  geom_bar(stat = "identity", colour = "white", linewidth = 0.01, fill = "#c04384") +
  ylab("Aandeel bezet") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 9),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.title = element_text(size = 9)
  ),
  tooltip = "text")
```

Top 10 meest wijdverspreide soorten (soort + (perc. van Vlaamse oppervlak waarop soort voorkomt)):  

1. Nijlgans (8.2%)  
2. Canadese gans (5.5%)  
3. Aziatische hoornaar (4.6%)  
4. Amerikaanse vogelkers (2.9%)  
5. invasieve duizendknopen  (1.9%)  
6. reuzenbalsemien (1.5%)  
7. muskusrat (1.1%)  
8. late guldenroede (0.8%)  
9. reuzenberenklauw (0.7%)  
10. rimpelroos (0.5%)

# HABITATRICHTLIJN

## Overzicht habitatrichtlijngebieden (SBZ-H)

### Wat is de habitatrichtlijn? 

De **Europese Habitatrichtlijn** (European Commission, 1992) beoogt de instandhouding van de natuurlijke leefmilieus en de wilde flora en fauna in Europa. Meer specifiek gaan de EU lidstaten de verbintenis aan om een aantal habitattypes en soorten (opgenomen in de bijlagen van voornoemde richtlijn) op hun grondgebied in een gunstige staat van instandhouding te brengen en te behouden (artikel 2 van de richtlijn). Dit gebeurt onder meer via het aanduiden, beschermen en beheren van speciale beschermingszones in het Natura 2000 netwerk. 

In bijlage I en II bij deze richtlijn zijn typen habitats en soorten opgenomen voor de instandhouding waarvan aanwijzing van speciale beschermingszones is vereist. Sommige hiervan worden gedefinieerd als „prioritaire” habitats of soorten die dreigen te verdwijnen en waarvoor specifieke regels gelden.  

typen habitats: N2000 habitats  
soorten: SBP soorten?   

### Habitatrichtlijngebieden in Vlaanderen

In totaal werden 38 habitatrichtlijngebieden in Vlaanderen aangeduid.
```{r kaart-hbtrl, echo=FALSE, fig.cap="Weergave van de habitatrichtlijngebieden in Vlaanderen", message=FALSE, warning=FALSE}
ggplotly(
  ggplot() +
    geom_sf(data = Provincies_grenzen, fill= "#f0f0f0", linewidth = 0.2) +
    geom_sf(data = ps_hbtrl_deel, color= "black", fill="#a4e98f", linewidth = 0.03, aes(group = naam, text = paste0(naam, " (", gebcode, ")"))) +
    theme_map(), 
  tooltip = "text")
```

```{r tabel-hbtrl, echo=FALSE, message=FALSE}
kable(ps_hbtrl %>% st_drop_geometry(), col.names = c("Code", "Naam", "Oppervlakte (ha)"), 
      align = "llr",
      caption = "Overzicht van de habitatrichtlijngebieden (SBZ-H) in Vlaanderen en hun oppervlakte (in ha)", 
      booktabs = TRUE) %>%
  kable_styling(bootstrap_options = "responsive",
                position = "center",
                font_size = 12,
                htmltable_class = "lightable-classic")
```

Kaartje habitatrichtlijngebieden ingekleurd volgens oppervlak: 
```{r kaart-hbtrl-area, echo=FALSE, warning=FALSE}
ps_hbtrl <- st_cast(ps_hbtrl, "MULTIPOLYGON")

ggplotly(
  ggplot() +
    geom_sf(data = Provincies_grenzen, fill= "#f0f0f0", linewidth = 0.2) +
    geom_sf(data = ps_hbtrl, aes(color = gebopp_ha, fill = gebopp_ha, text = paste0(naam, " (", gebcode, "): ", gebopp_ha, "ha"))) +
    scale_fill_gradient(low = "white", high = "#c04384") +
    scale_color_gradient(low = "white", high = "#c04384") +
    theme_map(), 
  tooltip = "text")
```

## IUS in habitatrichtlijngebieden

### Gebiedsgericht

#### Totaal aantal IUS per habitatrichtlijngebied 
```{r n-ias-in-hbtrl, echo=FALSE, warning=FALSE}
HBTRL_nspec <- HBTRL %>%
  filter(gebied != "HBTRL" & type == "of" & overlap != 0) %>%
  group_by(gebied) %>%
  summarize(total_species = n()) %>%
  left_join(ps_hbtrl, by = c("gebied" = "gebcode")) %>%
  st_as_sf() %>%
  st_cast("MULTIPOLYGON")

HBTRL_nspec <- HBTRL_nspec %>%
  mutate(number_bin = cut(total_species, breaks = c(9, 19, 29, 39, 49), labels = c("10-20", "20-30", "30-40", ">40")))

colors <- c("10-20" = "#e6b4ce", "20-30" = "#d98eb5", "30-40" = "#cd699d", ">40" = "#c04384")
colors <- c("10-20" = "#497364", "20-30" = "#8cb898", "30-40" = "#bb6e8c", ">40" = "#a43e66")

ggplotly(
  ggplot() +
    geom_sf(data = Provincies_grenzen, fill= "#f0f0f0", linewidth = 0.2) +
    geom_sf(data = HBTRL_nspec, aes(color = number_bin, fill = number_bin, text = paste0(naam, " (", gebied, "): ", total_species))) +
    scale_fill_manual(values = colors) +
    scale_color_manual(values = colors) +
    theme_map(), 
  tooltip = "text")
```

Komt in bepaalde mate overeen met rapportage Natuurrapport (zie pagina 20-21 van https://publicaties.vlaanderen.be/view-file/39618)  

Vijf habitatrichtlijngebieden met het **hoogste aantal IUS**? 

1. Schelde- en Durme-estuarium van de Nederlandse grens tot Gent (BE2300006): 42  
2. Valleigebied van de Kleine Nete met brongebieden, moerassen en heiden (BE2100026): 41  
3. Demervallei (BE2400014): 39  
4. Bovenloop van de Grote Nete met Zammelsbroek, Langdonken en Goor (BE2100040): 38  
5. Valleien van de Laambeek, Zonderikbeek, Slangebeek en Roosterbeek met vijvergebieden en heiden (BE2200031): 38  

Vijf habitatrichtlijngebieden met het **laagste aantal IUS**?  

1.	Plateau van Caestert met hellingbossen en mergelgrotten (BE2200036): 10  
2.	Voerstreek (BE2200039): 11  
3.	Jekervallei en bovenloop van de Demervallei (BE2200041): 13  
4.	Mangelbeek en heide- en vengebieden tussen Houthalen en Gruitrode (BE2200030)  
5.	Bosbeekvallei en aangrenzende bos- en heidegebieden te As-Opglabbeek-Maaseik (BE2200043): 16  

#### Welke IUS komen voor in een habitatrichtlijngebied?

Weergegeven als percentage van totale oppervlak van habitatrichtlijngebied dat "bezet" wordt door een soort. Hieronder wordt ter illustratie de top 10 meest voorkomende soorten voor drie gebieden weergegeven. Gekozen voor drie gebieden die qua milieu relatief ver uit elkaar liggen, is er ook een verschil te zien in top 10 IUS die er voorkomen: 
- BE2500001: Duingebieden inclusief IJzermonding en Zwin --> gekenmerkt door kustgebonden soorten zoals rimpelroos, mahonie, boksdoorn, struikaster, ... 
- BE2100020: Heesbossen, Vallei van Marke en Merkske en Ringven met valleigronden langs de Heerlese Loop
- BE2100040: Bovenloop van de Grote Nete met Zammelsbroek, Langdonken en Goor

```{r spec-in-hbtrl, echo=FALSE}
x <- HBTRL %>%
  filter(gebied %in% c("BE2500001", "BE2100020", "BE2100040") & type == "of") %>%
  group_by(gebied) %>%
  slice_max(n = 10, order_by = overlap)

ggplot(x, aes(x = overlap, y = reorder(soort, overlap))) +
  geom_bar(stat = "identity", fill = "#c04384") +
  facet_wrap(~gebied, ncol = 3, scales = "free_x") +
  labs(y = NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Soortgericht

#### Welke soorten komen (niet) voor in habitatrichtlijngebieden?
```{r list-ias-in-hbtrl, echo=FALSE}
# HBTRL %>%
#   filter(gebied == "HBTRL" & type == "in") %>% # & !soort %in% spor_species$Soort
#   select(soort, overlap) %>%
#   mutate(overlap = round(overlap, 3)) %>%
#   st_drop_geometry() %>%
#   arrange(overlap) %>%
#   mutate() %>%
#   flextable() %>%
#   #table_theme() %>%
#   mk_par(j = 2,
#          value = as_paragraph(
#            minibar(value = overlap + 0.01, max = 1, barcol = "#e5b3cd"),
#            as_chunk(overlap)),
#          part = "body") %>%
#   color(part = "body", i = ~ overlap == 0, color = "darkgrey", j = c(1,2)) %>%
#   autofit() %>%
#   width(j = 2, width = 2.8, unit = "cm") %>%
#   footnote(i = 1, j = 1, value = as_paragraph(c("soorten zonder overlap met habitatrichtlijngebied in grijs")), ref_symbols = c("1"), part = "header", inline = TRUE)

# species_not_in_hbtrl <- HBTRL %>%
#   filter(gebied == "HBTRL" & type == "in" & overlap == 0) %>%
#   select(soort, species) %>%
#   st_drop_geometry()
# # 
# kable(species_not_in_hbtrl, col.names = c("soort", "wetenschappelijke naam"), caption = "Soorten zonder overlap met habitatrichtlijngebied", booktabs = TRUE) %>%
#   kable_styling(bootstrap_options = "responsive",
#                 position = "center",
#                 font_size = 12,
#                 htmltable_class = "lightable-classic",
#                 html_font = 'Calibri')

x <- HBTRL %>%
  filter(gebied == "HBTRL" & type == "of")  %>%
  mutate(label_color = ifelse(overlap == 0, "lightgrey", "black"))

# Labels en kleuren aanmaken
label_colors <- setNames(x$label_color, x$soort)

# Plot met aangepaste kleuren voor x-as labels
ggplotly(
  ggplot(x , aes(x = reorder(soort, overlap), y = overlap)) +
    geom_bar(stat = "identity", fill = "#c04384", aes(text = paste0(soort, " (", round(overlap*100, 1), "%)"))) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.title.x = element_blank()) +
    scale_x_discrete(labels = function(soort) {
      # Pas de kleur van de labels aan afhankelijk van de overlap
      sapply(soort, function(s) {
        paste0("<span style='color:", label_colors[s], "'>", s, "</span>")
      })
    }) +
    theme(axis.text.x = ggtext::element_markdown()),
  tooltip = "text",
  height = 700)
```

#### In hoeveel habitatrichtlijngebieden komen de soorten voor?
```{r hbtrl-n-geb, echo=FALSE, message=FALSE, warning=FALSE}
HBTRL_ngeb <- HBTRL %>%
  filter(gebied != "HBTRL" & type == "in" & overlap != 0) %>%
  group_by(soort) %>%
  summarise(n_geb = n()) %>%
  mutate(perc = round((n_geb / 38) * 100, 1))

# ggplotly(
#   ggplot(data = HBTRL_ngeb, aes(x = reorder(soort, n_geb), y = n_geb)) +
#     geom_bar(stat = "identity", color = "white", linewidth = 0.0001, fill = "#c04384", aes(text = paste0(soort, " (", n_geb, " gebieden)"))) +
#     theme_bw() +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3),  # Tekst onder 45 graden en netjes tegen de as
#         axis.title.x = element_blank()) +
#     scale_y_continuous(
#       name = "Aantal SBZ-H",  # Linker y-as titel
#       sec.axis = sec_axis(~ . * 100 / 38, name = "Percentage van totaal (%)")  # Rechter y-as als percentage
#   ), 
#   tooltip = "text")

ggplot(data = HBTRL_ngeb, aes(x = reorder(soort, n_geb), y = n_geb)) +
    geom_bar(stat = "identity", color = "white", linewidth = 0.0001, fill = "#c04384", aes(text = paste0(soort, " (", n_geb, " gebieden)"))) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3),  # Tekst onder 45 graden en netjes tegen de as
        axis.title.x = element_blank()) +
    scale_y_continuous(
      name = "Aantal SBZ-H",  # Linker y-as titel
      sec.axis = sec_axis(~ . * 100 / 38, name = "Percentage van totaal (%)")  # Rechter y-as als percentage
  )
```

Nijlgans, Canadese gans, Invasieve duizendknopen komen in ALLE habitatrichtlijngebieden voor!

#### Voorkomen IAS in percentage {.tabset}

##### Percentage van habitatrichtlijn (ofHBTRL)
```{r figuur-of-HBTRL, echo=FALSE, message=FALSE}
of_HBTRL <- HBTRL %>%
  filter(gebied == "HBTRL" & type == "of" & overlap != 0)

ggplotly(
  ggplot(data = of_HBTRL, aes(x = reorder(soort, overlap), y = overlap, text = paste0(soort, "<br>Aandeel van totale oppervlak habitatrichtlijngebied dat bezet is: ", round(overlap * 100, 2), "%"))) +
  geom_bar(stat = "identity", colour = "white", linewidth = 0.01, fill = "#c04384") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 9),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.title = element_text(size = 9)
  ),
  tooltip = "text")
```

Resultaat zeer vergelijkbaar met resultaten voor PrIUS rapport: wijdverspreide soorten komen het meest abundant in habitatrichtlijn gebieden voor. Dit is natuurlijk logisch. Dit zijn soorten zoals de nijlgans (*Alopochen aegyptiaca*), Canadese gans (*Branta canadensis*), Amerikaanse vogelkers (*Prunus serotina*), reuzenbalsemien (*Impatiens glandulifera*) en invasieve duizendknopen (*Reynoutria japonica*), ... die over heel het Vlaamse grondgebied wijdverspreid voorkomen en dus ook in habitatrichtlijngebieden. Dit zijn ook de soorten die tijdens de workshop het meest aan bod kwamen van de boswachter uit. Deze soorten dragen de kroon van verspreiding en last in Vlaanderen. Hiervan staan echter uitsluitend de nijlgans en reuzenbalsemien op de unielijst!!!! Aanpak voor Europa strookt niet perse met aanpak voor Vlaanderen.

##### Percentage in habitatrichtlijn (inHBTRL)
```{r figuur-in-HBTRL, echo=FALSE, message=FALSE}
in_HBTRL <- HBTRL %>%
  filter(gebied == "HBTRL" & type == "in" & overlap != 0)

ggplotly(
  ggplot(data = in_HBTRL, aes(x = reorder(soort, overlap), y = overlap, text = paste0(soort, "<br>Aandeel van verspreiding dat in Habitatrichtlijngebied ligt: ", round(overlap * 100, 2), "%"))) +
  geom_bar(stat = "identity", colour = "white", linewidth = 0.01, fill = "#c04384") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 9),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.title = element_text(size = 9)
  ),
  tooltip = "text")
```

Soorten met meer dan 50% van totale Vlaamse verspreiding in habitatrichtlijngebied:

1. Chinese moerasslak (Cch): 74.6%  
2. Siberische grondeekhoorn (Tsi): 68.4%  
3. Amerikaanse hondsvis (Up): 67.2%  
4. Sikahert (Cn): 58.6%    

##### In vs. of
```{r in-vs-of, echo=FALSE, message=FALSE}
in_vs_of_HBTRL <- in_HBTRL %>%
  select(!type) %>%
  left_join(of_HBTRL %>% select(!type), by = c("soort", "species", "abbr", "gebied"), suffix = c(".in", ".of"))

ggplot() +
  geom_text(data = in_vs_of_HBTRL, aes(x = overlap.in, y = overlap.of, label = abbr)) +
  xlim(0,1) +
  coord_trans(y = "log2") +
  xlab("Aandeel totale verspreiding dat overlapt met habitatrichtlijngebied") + ylab("aandeel totaal oppervlak habitatrichtlijngebied dat bezet is") +
  theme_bw()
```

-   De soorten die in grote mate overlappen met habitatrichtlijngebieden/soorten die het totaal areaal aan habitatrichtlijngebieden het sterkt impacteren: nijlgans (Aae), Canadese gans (Bc), Amerikaanse vogelkers (Pse), reuzenbalsemien (Ig). Echter, deze soorten vertonen een algemeen lagere specificiteit voor de habitatrichtlijngebieden. Het zijn wijdverspreide soorten die niet specifiek voorkeur geven aan habitatrichtlijngebieden.  
-   Soorten die het sterkst aan habitatrichtlijngebieden gebonden zijn (inHBTRL \< 0.5): Chinese moerasslak (Cch), Amerikaanse hondsvis (Up), Siberische grondeekhoorn (Tsi), Sikahert (Cn). *Opgelet* Chinese moerasslak is een sporadische soort met slechts 6 waarnemingen sinds 2015.  
-   Soorten die het minst aan habitatrichtlijngebieden gebonden zijn (inHBTRL \> 0.05): Chinese prachtslang (Et), Aziatische hoornaar (Vv), Kaapse waterlelie (Ad), Turkse rivierkreeft (Plep), hemelboom (Aal)  

#### In welke habitatrichtlijngebieden komen soorten voor {.tabset}
##### Amerikaanse hondsvis
```{r overlap-map-am-hondsvis-hbtrl, results='asis', echo=FALSE, warning=FALSE}
df <- HBTRL_spatial %>%
  filter(soort == "Amerikaanse hondsvis" & type == "in" & gebied != "HBTRL" & overlap != 0) %>%
  st_cast("MULTIPOLYGON")

occs <- occ_flanders %>%
  filter(Soort == "Amerikaanse hondsvis") 

pal <- colorNumeric(
  palette = "Reds",
  domain = df$overlap)

ggplotly(ggplot() +
  geom_sf(data = Provincies_grenzen, fill = "#f0f0f0", linewidth = 0.2) +
  geom_sf(data = ps_hbtrl, fill = "grey80", color = "grey80", size = 0.5) +
  geom_sf(data = df, aes(text = paste0(naam, " (", gebied, "): ", round(overlap * 100, 1), "%")), fill = "#c04384", color = "#c04384",, size = 0.5) +
  geom_sf(data = occs, color = "blue") +
  theme_map())

ggplotly(ggplot() +
           geom_bar(data = df, aes(x = overlap, y = reorder(str_wrap(paste(df$naam, "(<b>", gebied, "</b>)"), width = 40), overlap), text = paste0(gebied, " (", naam, "): ", round(overlap * 100, 1), "%")), stat = "identity", colour = "#c04384", fill = "#c04384") +
           theme_bw() +
           theme(axis.text.x = element_text(angle = 90),
                 axis.title.y = element_blank()
           ) +
           scale_x_continuous(labels = scales::percent_format(accuracy = 1)), 
         tooltip = "text")
```

##### Siberische grondeekhoorn
```{r overlap-map-sib-grondeekhoorn-hbtrl, results='asis', echo=FALSE, warning=FALSE}
df <- HBTRL_spatial %>%
  filter(soort == "Siberische grondeekhoorn" & type == "in" & gebied != "HBTRL" & overlap != 0) %>%
  st_cast("MULTIPOLYGON")

occs <- occ_flanders %>%
  filter(Soort == "Siberische grondeekhoorn")

pal <- colorNumeric(
  palette = "Reds",
  domain = df$overlap)

ggplotly(ggplot() +
  geom_sf(data = Provincies_grenzen, fill = "#f0f0f0", linewidth = 0.2) +
  geom_sf(data = ps_hbtrl, fill = "grey80", color = "grey80", size = 0.5) +
  geom_sf(data = df, aes(text = paste0(naam, " (", gebied, "): ", round(overlap * 100, 1), "%")), fill = "#c04384", color = "#c04384",, size = 0.5) +
  geom_sf(data = occs, color = "blue") +
  theme_map())

ggplotly(ggplot() +
           geom_bar(data = df, aes(x = overlap, y = reorder(str_wrap(paste(df$naam, "(<b>", gebied, "</b>)"), width = 40), overlap), text = paste0(gebied, " (", naam, "): ", round(overlap * 100, 1), "%")), stat = "identity", colour = "#c04384", fill = "#c04384") +
           theme_bw() +
           theme(axis.text.x = element_text(angle = 90),
                 axis.title.y = element_blank()
           ) +
           scale_x_continuous(labels = scales::percent_format(accuracy = 1)), 
         tooltip = "text")
```

##### sikahert
```{r overlap-map-sikahert-hbtrl, results='asis', echo=FALSE, warning=FALSE}
df <- HBTRL_spatial %>%
  filter(soort == "sikahert" & type == "in" & gebied != "HBTRL" & overlap != 0) %>%
  st_cast("MULTIPOLYGON")

occs <- occ_flanders %>%
  filter(Soort == "sikahert") 

pal <- colorNumeric(
  palette = "Reds",
  domain = df$overlap)

ggplotly(ggplot() +
  geom_sf(data = Provincies_grenzen, fill = "#f0f0f0", linewidth = 0.2) +
  geom_sf(data = ps_hbtrl, fill = "grey80", color = "grey80", size = 0.5) +
  geom_sf(data = df, aes(text = paste0(naam, " (", gebied, "): ", round(overlap * 100, 1), "%")), fill = "#c04384", color = "#c04384",, size = 0.5) +
  geom_sf(data = occs, color = "blue") +
  theme_map())

ggplotly(ggplot() +
           geom_bar(data = df, aes(x = overlap, y = reorder(str_wrap(paste(df$naam, "(<b>", gebied, "</b>)"), width = 40), overlap), text = paste0(gebied, " (", naam, "): ", round(overlap * 100, 1), "%")), stat = "identity", colour = "#c04384", fill = "#c04384") +
           theme_bw() +
           theme(axis.text.x = element_text(angle = 90),
                 axis.title.y = element_blank()
           ) +
           scale_x_continuous(labels = scales::percent_format(accuracy = 1)), 
         tooltip = "text")
```

# VOGELRICHTLIJN

## Overzicht vogelrichtlijngebieden (SBZ-V)

### Wat is de vogelrichtlijn? 

### Vogelrichtlijngebieden in Vlaanderen

In totaal werden 24 vogelrichtlijngebieden in Vlaanderen aangeduid.
```{r kaart-vglrl, echo=FALSE, fig.cap="Weergave van de vogelrichtlijngebieden in Vlaanderen", message=FALSE, warning=FALSE}
ggplotly(
  ggplot() +
    geom_sf(data = Provincies_grenzen, fill= "#f0f0f0", linewidth = 0.2) +
    geom_sf(data = ps_vglrl, color= "black", fill="#a4e98f", linewidth = 0.03, aes(group = gebnaam, text = paste0(gebnaam, " (", na2000code, ")"))) +
    theme_map(), 
  tooltip = "text")
```

```{r tabel-vglrl, echo=FALSE, message=FALSE}
kable(ps_vglrl %>% st_drop_geometry() %>% select(na2000code, gebnaam, oppervlakte), col.names = c("Code", "Naam", "Oppervlakte (ha)"), 
      align = "llr",
      caption = "Overzicht van de vogelrichtlijngebieden (SBZ-V) in Vlaanderen en hun oppervlakte (in ha)", 
      booktabs = TRUE) %>%
  kable_styling(bootstrap_options = "responsive",
                position = "center",
                font_size = 12,
                htmltable_class = "lightable-classic")
```

## IUS in vogelrichtlijngebieden 

Voor het rapport beperken we ons tot de vogelsoorten. Waterrijke (en dus vogelrijke) gebieden indachtig, breiden we deze selectie ter illustratie uit met een aantal notoire predatoren (wasbeer, wasbeerhond, Amerikaanse nerts) en aquatische knaagdieren (beverrat en muskusrat). 

soorten die voor het voorkomen in habitatrichtlijngebied worden meegenomen: 
```{r}
species_vglrl <- c("treurmaina","nijlgans","beverrat","wasbeerhond","muskusrat","rosse stekelstaart","wasbeer","heilige ibis","Canadese gans","Amerikaanse nerts")


kable(species_list %>% filter(Soort %in% species_vglrl) %>% select(Soort, Species), 
      align = "llr",
      booktabs = TRUE) %>%
  kable_styling(bootstrap_options = "responsive",
                position = "center",
                font_size = 12,
                htmltable_class = "lightable-classic")
```

### Gebiedsgericht

#### Totaal aantal IUS per vogelrichtlijngebied

Beperkt tot relevante soorten voor vogelrichtlijngebieden

```{r n-ias-in-vglrl, echo=FALSE, warning=FALSE}
VGLRL_nspec <- VGLRL %>%
  filter(soort %in% species_vglrl & gebied != "VGLRL" & type == "of" & overlap != 0) %>%
  group_by(gebied) %>%
  summarize(total_species = n()) %>%
  left_join(ps_vglrl, by = c("gebied" = "na2000code")) %>%
  st_as_sf() %>%
  st_cast("MULTIPOLYGON")

ggplotly(
  ggplot() +
    geom_sf(data = Provincies_grenzen, fill= "#f0f0f0", linewidth = 0.2) +
    geom_sf(data = VGLRL_nspec, aes(color = total_species, fill = total_species, text = paste0(gebnaam, " (", gebied, "): ", total_species))) +
    theme_map(), 
  tooltip = "text")
```

#### Welke IUS komen voor in een vogelrichtlijngebied? 
```{r spec-in-SBZ-V, echo=FALSE}
x <- VGLRL %>%
  filter(soort %in% species_vglrl & gebied %in% c("BE2301235", "BE2500932", "BE2200727") & type == "in") %>%
  group_by(gebied)

ggplot(x, aes(x = overlap, y = reorder(soort, overlap))) +
  geom_bar(stat = "identity", fill = "#c04384") +
  facet_wrap(~gebied, ncol = 3, scales = "free_x") +
  labs(y = NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Soortgericht

#### Welke soorten komen (niet) voor in vogelrichtlijngebieden? 

beperkt tot relevante soorten zoals eerder vermeld. 
```{r spec-in-vglrl, echo=FALSE, warning=FALSE}
x <- VGLRL %>%
  filter(soort %in% species_vglrl & gebied == "VGLRL" & type == "of")  %>%
  mutate(label_color = ifelse(overlap == 0, "lightgrey", "black"))

# Labels en kleuren aanmaken
label_colors <- setNames(x$label_color, x$soort)

# Plot met aangepaste kleuren voor x-as labels
ggplotly(
  ggplot(x , aes(x = reorder(soort, overlap), y = overlap)) +
    geom_bar(stat = "identity", fill = "#c04384", aes(text = paste0(soort, " (", round(overlap*100, 1), "%)"))) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.title.x = element_blank()) +
    scale_x_discrete(labels = function(soort) {
      # Pas de kleur van de labels aan afhankelijk van de overlap
      sapply(soort, function(s) {
        paste0("<span style='color:", label_colors[s], "'>", s, "</span>")
      })
    }) +
    theme(axis.text.x = ggtext::element_markdown()),
  tooltip = "text",
  height = 700)
```

treurmaina en wasbeerhond komen tot op heden niet voor in vogelrichtlijngebied. 

#### In hoeveel vogelrichtlijngebieden komen de relevante soorten voor? 
```{r vglrl-n-gebieden, echo=FALSE}
x <- VGLRL %>%
  filter(soort %in% species_vglrl & gebied != "VGLRL" & type == "of" & overlap != 0) %>%
  group_by(soort) %>%
  summarise(n_geb = n())

ggplotly(
  ggplot(x, aes(x = reorder(soort, n_geb), y = n_geb)) +
    geom_bar(stat = "identity", fill = "#c04384", aes(text = paste0(soort, " (", n_geb, " SBZ-V)"))) +
    labs(x = NULL, y = "Aantal SBZ-V") +
    theme_bw(),
  tooltip = "text")
```

Nijlgans en Canadese gans komen in ALLE vogelrichtlijngebieden voor! 

#### In welke  vogelrichtlijngebieden komt een soort voor? {.tabset}
##### rosse stekelstaart
```{r overlap-stekelstaart-vglrl, results='asis', echo=FALSE, warning=FALSE}
df <- VGLRL_spatial %>%
  filter(soort == "rosse stekelstaart" & type == "in" & gebied != "VGLRL" & overlap != 0) %>%
  st_cast("MULTIPOLYGON")

occs <- occ_flanders %>%
  filter(Soort == "rosse stekelstaart") 

pal <- colorNumeric(
  palette = "Reds",
  domain = df$overlap)

ggplotly(ggplot() +
  geom_sf(data = Provincies_grenzen, fill = "#f0f0f0", linewidth = 0.2) +
  geom_sf(data = ps_vglrl, fill = "grey80", color = "grey80", size = 0.5) +
  geom_sf(data = df, aes(text = paste0(gebnaam, " (", gebied, "): ", round(overlap * 100, 1), "%")), fill = "#c04384", color = "#c04384", size = 0.5) +
  geom_sf(data = occs, color = "blue") +
  theme_map())

ggplotly(ggplot() +
           geom_bar(data = df, aes(x = overlap, y = reorder(str_wrap(paste(gebnaam, "(<b>", gebied, "</b>)"), width = 40), overlap), text = paste0(gebied, " (", gebnaam, "): ", round(overlap * 100, 1), "%")), stat = "identity", colour = "#c04384", fill = "#c04384") +
           theme_bw() +
           theme(axis.text.x = element_text(angle = 90),
                 axis.title.y = element_blank()
           ) +
           scale_x_continuous(labels = scales::percent_format(accuracy = 1)), 
         tooltip = "text")
```

##### Amerikaanse nerts
```{r overlap-am-nerts-vglrl, results='asis', echo=FALSE, warning=FALSE}
df <- VGLRL_spatial %>%
  filter(soort == "Amerikaanse nerts" & type == "in" & gebied != "VGLRL" & overlap != 0) %>%
  st_cast("MULTIPOLYGON")

occs <- occ_flanders %>%
  filter(Soort == "Amerikaanse nerts") 

pal <- colorNumeric(
  palette = "Reds",
  domain = df$overlap)

ggplotly(ggplot() +
  geom_sf(data = Provincies_grenzen, fill = "#f0f0f0", linewidth = 0.2) +
  geom_sf(data = ps_vglrl, fill = "grey80", color = "grey80", size = 0.5) +
  geom_sf(data = df, aes(text = paste0(gebnaam, " (", gebied, "): ", round(overlap * 100, 1), "%")), fill = "#c04384", color = "#c04384", size = 0.5) +
  geom_sf(data = occs, color = "blue") +
  theme_map())

ggplotly(ggplot() +
           geom_bar(data = df, aes(x = overlap, y = reorder(str_wrap(paste(gebnaam, "(<b>", gebied, "</b>)"), width = 40), overlap), text = paste0(gebied, " (", gebnaam, "): ", round(overlap * 100, 1), "%")), stat = "identity", colour = "#c04384", fill = "#c04384") +
           theme_bw() +
           theme(axis.text.x = element_text(angle = 90),
                 axis.title.y = element_blank()
           ) +
           scale_x_continuous(labels = scales::percent_format(accuracy = 1)), 
         tooltip = "text")
```

##### muskusrat
```{r overlap-muskusrat-vglrl, results='asis', echo=FALSE, warning=FALSE}
df <- VGLRL_spatial %>%
  filter(soort == "muskusrat" & type == "in" & gebied != "VGLRL" & overlap != 0) %>%
  st_cast("MULTIPOLYGON")

occs <- occ_flanders %>%
  filter(Soort == "muskusrat") 

pal <- colorNumeric(
  palette = "Reds",
  domain = df$overlap)

ggplotly(ggplot() +
  geom_sf(data = Provincies_grenzen, fill = "#f0f0f0", linewidth = 0.2) +
  geom_sf(data = ps_vglrl, fill = "grey80", color = "grey80", size = 0.5) +
  geom_sf(data = df, aes(text = paste0(gebnaam, " (", gebied, "): ", round(overlap * 100, 1), "%")), fill = "#c04384", color = "#c04384", size = 0.5) +
  geom_sf(data = occs, color = "blue", alpha = 0.3) +
  theme_map())

ggplotly(ggplot() +
           geom_bar(data = df, aes(x = overlap, y = reorder(str_wrap(paste(gebnaam, "(<b>", gebied, "</b>)"), width = 40), overlap), text = paste0(gebied, " (", gebnaam, "): ", round(overlap * 100, 1), "%")), stat = "identity", colour = "#c04384", fill = "#c04384") +
           theme_bw() +
           theme(axis.text.x = element_text(angle = 90),
                 axis.title.y = element_blank()
           ) +
           scale_x_continuous(labels = scales::percent_format(accuracy = 1)), 
         tooltip = "text")
```

# NATURA 2000 HABITATS

## Overzicht N2000 habitats

### Wat zijn Natura 2000 (N2000) habitats?

Binnen de habitatrichtlijn werden in Bijlage I habitattypes aangeduid die bescherming verdienen in Europa. Deze habitattypes bevinden zich zowel binnen als buiten de speciale beschermingszones/habitatrichtlijngebieden. De kaartlaag die wij gebruiken, geeft de totale verspreiding van de habitattypes in Vlaanderen weer, ook deze buiten de SBZ-H's

Zaken waar ik rekening mee moet houden bij de analyses van de N2000 habitattypes!

- de verspreiding van deze habitattypes werd afgeleid van de BWK/N2000 habitatkaart. Hierin worden soms meerdere habitattypes en regionaal belangrijke biotopen samengezet binnen een gebied, gelinkt aan een inschatting van het percentage oppervlak dat ieder type hier inneemt. Voor onze analyses, werd bij voorkomen van een habitat binnen een gebied steeds uitgegaan van een 100% aanwezigheid over dit hele gebied, aangezien we niet exact weten waar het percentage van dit type habitat zich bevindt binnen het afgelijnde gebied.
- per soort worden de N2000 habitattypes telkens beperkt tot de voor die soort relevante habitattypes o.b.v. het milieu waarin die soort voorkomt. (vb. voor zoetwaterorganismen, worden alleen zoetwater habitats in rekening gebracht). Dit aangezien de buffer rondom puntlocaties soms ook irrelevante habitattypes meeneemt. vb. een strikt aquatische plant in een kleine vijver, wordt gebufferd met 100m en neemt op die manier ook de omliggende terrestrische habitattypes in rekening. Dit is in kader van kijken naar impact op natuurtypes niet relevant en verwarrend.

### Overzicht van N2000 habitats in Vlaanderen

In Vlaanderen komen 46 habitattypen van de Bijlage I van de Habitatrichtlijn voor (Paelinckx et
al., 2019). **OPGELET** wij gaan in onze analyse verder met 45 N2000 habitats, habitattype 8310 (niet voor publiek opengestelde grotten) wordt achterwege gelaten.

Voor de drie habitattypen **2310** (droge heide op landduinen), **2330** (open grasland op landduinen) en **9190** (oude eiken-berkenbossen) heeft Vlaanderen ‘een bijzondere verantwoordelijkheid’ in de EU-Atlantische regio. Het is belangrijk dat Vlaanderen daarvoor proactief initiatief neemt, bv. in EU-netwerken, zoals bv. in het EU Atlantic biogeographical seminar. Dit geldt ook voor habitats waarvoor Vlaanderen zeer belangrijk is, namelijk 1130, 2130, 6120, 6230, 9130 en 91E0.

Het Vlaams Natura 2000 programma legt de prioriteiten vast van het Vlaamse beleid. Daarin wordt via het operationaliseren van instandhoudingsmaatregelen een verbetering van habitats en soorten vooropgesteld. Het ontwerp Natura 2000 programma 2021 – 2026 bevat ook een lijst van habitats met als bindende taakstelling de verbetering van de staat van instandhouding tegen 2026. Daarin zijn drie habitattypen opgenomen waarvoor Vlaanderen in de EU-Atlantische regio zeer belangrijk is:

- ‘2130 vastgelegde duinen’
- ‘6120 stroomdalgraslanden’
- ‘91E0 vochtige alluviale bossen’

De overige habitats waarvoor Vlaanderen zeer belangrijk of essentieel is in Europa staan niet in die lijst, maar wel als leefgebied van soorten waarvoor het programma acties voorziet.

```{r n2khab-table, echo=FALSE}
n2khab_table <- n2khab %>%
  st_drop_geometry() %>%
  transmute(code, habitat, opp_ha = round(oppervlak / 10000, 2))

kable(n2khab_table,
      align = "llr",
      caption = "Overzicht N2000 habitattypes in Vlaanderen", 
      booktabs = TRUE) %>%
  kable_styling(bootstrap_options = "responsive",
                position = "center",
                font_size = 12,
                htmltable_class = "lightable-classic")
```

```{r n2khab-kaart, fig.cap="Weergave van de Natura 2000 habitattypes in Vlaanderen", echo=FALSE}
# ggplotly(
#   ggplot() +
#     geom_sf(data = Provincies_grenzen, fill= "#f0f0f0", size = 0.2) +
#     geom_sf(data = n2khab, color= "#a4e98f", fill="#a4e98f", aes(text = paste0(shortname, " (", code, ")"))) +
#     theme_void(),
#   tooltip = "text")
```

## IUS in N2000 habitats

### Gebiedsgericht

#### Aantal IUS per habitattype
```{r n2khab-nspec-pertype, echo=FALSE, message=FALSE}
N2KHAB_nospec <- N2KHAB %>%
  filter(gebied != "N2KHAB" & type == "in") %>%
  group_by(gebied) %>%
  summarise(tot_overlap = sum(overlap)) %>%
  filter(tot_overlap == 0) %>%
  pull(gebied)

# geen IUS in habitattypes 2150 (vastgelegde ontkalkte duinen) en 91F0 (hardhoutooibossen)

N2KHAB_nspec_pertype <- N2KHAB %>%
  filter(gebied != "N2KHAB" & type == "of" & overlap != 0) %>%
  left_join(habitats, by = c("gebied" = "code")) %>%
  group_by(groep, gebied) %>%
  summarise(n_spec = n()) %>%
  ungroup() %>%
  add_row(groep = "kustduinen", gebied = "2150", n_spec = 0) %>% # voeg handmatig de twee habitattypes toe waar geen IUS voorkomen
  add_row(groep = "bossen", gebied = "91F0", n_spec = 0)

# barplot
# ggplotly(
#   ggplot(N2KHAB_nspec_pertype, aes(x = reorder(gebied, n_spec), y = n_spec)) +
#     geom_bar(stat = "identity", fill = "#c04384") +
#     facet_wrap(~ groep, scales = "free_x", nrow = 1, strip.position = "bottom") +
#     labs(x = "Habitattype", y = "Aantal IUS") +
#     theme_bw() +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1),
#           strip.placement = "outside",
#           strip.background = element_blank()),
#   tooltip = "text")
# 
# ggplot(N2KHAB_nspec_pertype, aes(x = reorder(gebied, n_spec), y = n_spec)) +
#     geom_bar(stat = "identity", fill = "#c04384") +
#     facet_wrap(~ groep, scales = "free_x", nrow = 1, strip.position = "bottom") +
#     labs(x = NULL, y = "Aantal IUS") +
#     theme_classic() +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1),
#           strip.placement = "outside")

ggplot(N2KHAB_nspec_pertype, aes(x = reorder(gebied, n_spec), y = n_spec)) +
    geom_bar(stat = "identity", fill = "#c04384") +
    facet_wrap(~ groep, scales = "free_x", nrow = 1) +
    labs(x = "Habitattype", y = "Aantal IUS") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          strip.placement = "outside")
```

##### Habitattypes zonder IUS?  

- **91F0** (hardhoutooibossen)  
- **2150** (vastgelegde ontkalkte duinen)  

##### Habitattypes met het meeste IUS?  
- **91E0** (vochtige alluviale bossen): 62 IUS  
- **7140** (overgangs- en trilveen): 37 IUS  
- **4010** (vochtige heide): 32 IUS  

##### Voor de drie habitattypes waar het meeste IUS voorkomen, wat zijn de 10 meest voorkomende IUS? 

Weergave van top 10 voorkomende soorten voor de drie habitattypes met het hoogste aantal IUS in Vlaanderen. Weergegeven als het percentage van het totale oppervlakte van dit habitattype in Vlaanderen dat wordt ingenomen door de soort. 

vb. voorkomen van Canadese gans in vochtige heide is 20.3%: Canadese gans komt voor op 20.3% van het totale oppervlakte vochtige heide in Vlaanderen. 

```{r echo=FALSE}
x <- N2KHAB %>%
  filter(gebied != "N2KHAB" & type == "of" & overlap != 0) %>%
  left_join(habitats, by = c("gebied" = "code")) %>%
  filter(gebied %in% c("91E0", "7140", "4010")) %>%
  group_by(gebied) %>%
  top_n(10, overlap)

ggplotly(
  ggplot(data = x, aes(x = reorder(soort, overlap), y = overlap *100)) +
    geom_bar(stat = "identity", fill = "#c04384") +
    facet_wrap(~gebied, scales = c("free_y"), nrow = 3, ncol = 1) +
    ylab("% van oppervlakte habitattype") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.title.x = element_blank()), 
  tooltip = "text")
```

### Soortgericht

#### Welke soorten komen in welke mate voor in N2000 hab? 
```{r of-n2khab, echo=FALSE}
x <- N2KHAB %>%
  filter(gebied == "N2KHAB" & type == "of")  %>%
  mutate(label_color = ifelse(overlap == 0, "lightgrey", "black"))

# Labels en kleuren aanmaken
label_colors <- setNames(x$label_color, x$soort)

# Plot met aangepaste kleuren voor x-as labels
ggplotly(
  ggplot(x , aes(x = reorder(soort, overlap), y = overlap)) +
    geom_bar(stat = "identity", fill = "#c04384", aes(text = paste0(soort, " (", round(overlap*100, 1), "%)"))) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.title.x = element_blank()) +
    scale_x_discrete(labels = function(soort) {
      # Pas de kleur van de labels aan afhankelijk van de overlap
      sapply(soort, function(s) {
        paste0("<span style='color:", label_colors[s], "'>", s, "</span>")
      })
    }) +
    theme(axis.text.x = ggtext::element_markdown()),
  tooltip = "text",
  height = 700)
```

#### Generalist vs. specialist

Vergelijk het voorkomen in Natura 2000 habitats tussen een generalist (watercrassula) en een specialist (struikaster).

Voorkomen wordt hier uitgedrukt in het percentage van het totale verspreidingsoppervlakte van de soort dat voorkomt in een habitattype (!OPGELET: nuance met vorige figuur).

```{r n2khab-gen-vs-spec, echo = FALSE}
x <- N2KHAB %>%
  filter(gebied != "N2KHAB" & type == "in" & soort %in% c("watercrassula", "struikaster")) %>%
  left_join(habitats, by = c("gebied" = "code"))

ggplot(x, aes(x = reorder(gebied, overlap), y = overlap)) +
    geom_bar(stat = "identity", fill = "#c04384") +
    facet_grid(soort ~ groep, scales = "free_x", switch = "y") +
    labs(x = "habitattype", y = NULL) +
    scale_y_continuous(sec.axis = dup_axis(name = "overlap")) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
          axis.ticks.y.left = element_blank(),
          axis.title.y.right = element_text(),  
          axis.title.y.left = element_blank(),  
          axis.text.y.right = element_text(),   
          axis.text.y.left = element_blank(),  
          strip.placement = "outside")
```

#### Aquatisch vs. terrestrisch
```{r n2khab-aqua-vs-terr, echo=FALSE}
x <- N2KHAB %>%
  filter(gebied != "N2KHAB" & type == "in" & soort %in% c("zwartbekgrondel", "hemelboom")) %>%
  left_join(habitats, by = c("gebied" = "code"))

ggplot(x, aes(x = reorder(gebied, overlap), y = overlap)) +
    geom_bar(stat = "identity", fill = "#c04384") +
    facet_grid(soort ~ groep, scales = "free_x", switch = "y") +
    labs(x = "habitattype", y = NULL) +
    scale_y_continuous(sec.axis = dup_axis(name = "overlap")) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
          axis.ticks.y.left = element_blank(),
          axis.title.y.right = element_text(),  
          axis.title.y.left = element_blank(),  
          axis.text.y.right = element_text(),   
          axis.text.y.left = element_blank(),  
          strip.placement = "outside", 
          panel.border = element_rect(color = "black"))
```

# NATUURBEHEERPLANNEN

# ANB PATRIMONIUM

## Overzicht ANB patrimonium

### Wat is het ANB patrimonium? 

### Overzicht ANB domeinen

#### Totaal aantal ANB-domeinen in Vlaanderen? 
```{r n-anb-domeinen, echo=FALSE}
length(unique(am_patdat$domennm))
```

#### Verdeling van rechten anb binnen deze domeinen? 
```{r patdat-type-beheerder, echo=FALSE}
patdat_summary <- am_patdat %>%
  st_drop_geometry() %>%
  group_by(rchtnnb) %>%
  summarise(n_domeinen = n())

custom_colors <- c("#f2cfe0", "#c04384", "#902653", "#681836", "#4b102f", "#e08ab8")
  
plot_ly(patdat_summary, labels = ~rchtnnb, values = ~n_domeinen, type = 'pie',
        textinfo = 'label+percent',
        insidetextorientation = 'radial',
        marker = list(colors = custom_colors)) %>%
  layout(showlegend = FALSE)

```

Een zéér groot aandeel van de ANB domeinen (61,8%) valt onder technisch beheer conform het Bosdecreet. Dit zijn bossen van publieke eigenaars (‘openbare bossen’) waar ten gevolge van het Bosdecreet (Art. 45) het technisch beheer wordt uitgevoerd door het ANB. 

Opmerking boswachter op workshop: voorstel om de analyse ook eens uit te voeren zonder deze domeinen.. Indien ik dit wil doen, moet ik de berekeningen van de metrics opnieuw uitvoeren.. --> zeker nog te bekijken (opdeling PATDAT output in PATDAT_incl_ob en PATDAT_excl_ob)

#### Oppervlakte per type beheerdersrecht
```{r opp-rechtenanb, echo=FALSE, message=FALSE, warning=FALSE}
am_patdat %>%
  group_by(rchtnnb) %>%
  summarise() %>%
  mutate(oppervlakte = st_area(geometry)) %>%
  st_drop_geometry() %>%
  ggplot(aes(x = reorder(rchtnnb, oppervlakte), y = oppervlakte)) +
    geom_bar(stat = "identity", fill = "#c04384") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.title.x = element_blank())
```

Ondanks de hoge hoeveelheid domeinen die vallen onder "openbare bossen", ligt het oppervlakte hiervan toch lager dan domeinen in eigendom van anb. 

#### Verdeling ANB domeinen over beheerregio's
```{r patdat-beheerregio, echo=FALSE, message=FALSE}
x <- am_patdat %>%
  st_drop_geometry() %>%
  group_by(regio, rchtnnb) %>%
  summarise(n_domeinen = n()) %>%
  drop_na()

custom_colors <- c("#f2cfe0", "#c04384", "#902653", "#681836", "#4b102f", "#e08ab8")

ggplot(x, aes(x = reorder(regio, n_domeinen), y = n_domeinen, fill = rchtnnb)) +
  geom_bar(stat = "identity") + 
  theme_bw() +
  labs(x = NULL, y = "# domeinen") +
  scale_fill_manual(values = custom_colors) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  

```

## IUS in ANB patrimonium

### Gebiedsgericht

#### Welke beheerregio's staan het meest onder druk? Aantal IUS per beheerregio
```{r nspec-per-br, echo=FALSE, message=FALSE, warning=FALSE}
x <- PATDAT %>%
  filter(gebied != "PATDAT" & type == "of" & overlap != 0) %>%
  group_by(gebied) %>%
  summarise(n_spec = n())

ggplot(x, aes(x = reorder(gebied, n_spec), y = n_spec)) +
  geom_bar(stat = "identity", fill = "#c04384") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.title.x = element_blank())
  

bw <- boswachterijen$boswachterijen_2024 %>%
  group_by(Regio) %>%
  summarise(geometry = st_union(geometry))
```

Aantal IUS verschilt niet zeer hard tussen de verschillende beheerregio's. Maar verschilt de top 10 meest voorkomende soorten? 

#### top 10 IUS per beheerregio
```{r patdat-top-10, echo=FALSE}
x <- PATDAT %>%
  filter(gebied != "PATDAT" & type == "of" & overlap != 0) %>%
  group_by(gebied) %>%
  slice_max(n = 10, order_by = overlap) %>%
  ungroup()

ggplotly(
  ggplot(x, aes(x = reorder(soort, overlap), y = overlap)) +
    geom_bar(stat = "identity", fill = "#c04384") +
    facet_wrap(~gebied, scales = "free_y", nrow = 10) +
    labs(x = NULL) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)), 
  tooltip = "text", height = 1000)
```

#### Per type recht van anb, hoeveel IUS? 

zien we hier dat het hoogste aantal IUS voorkomt in openbare bossen? 
```{r nspec-per-rechtenanb, echo=FALSE}
x <- PATDAT %>%
  filter(type == "anb_rechten" & overlap != 0) %>%
  group_by(gebied) %>%
  summarise(n_spec = n())

ggplot(x, aes(x = reorder(gebied, n_spec), y = n_spec)) +
  geom_bar(stat = "identity", fill = "#c04384") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.title.x = element_blank())
```
Hoogste aantal soorten in domeinen die in eigendom zijn van ANB! 

### Soortgericht

#### Welke soorten komen in welke mate voor in ANB domeinen? 
```{r of-patdat, echo=FALSE, warning=FALSE}
x <- PATDAT %>%
  filter(gebied == "PATDAT" & type == "of")  %>%
  mutate(label_color = ifelse(overlap == 0, "lightgrey", "black"))

# Labels en kleuren aanmaken
label_colors <- setNames(x$label_color, x$soort)

# Plot met aangepaste kleuren voor x-as labels
ggplotly(
  ggplot(x , aes(x = reorder(soort, overlap), y = overlap)) +
    geom_bar(stat = "identity", fill = "#c04384", aes(text = paste0(soort, " (", round(overlap*100, 1), "%)"))) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          axis.title.x = element_blank()) +
    scale_x_discrete(labels = function(soort) {
      # Pas de kleur van de labels aan afhankelijk van de overlap
      sapply(soort, function(s) {
        paste0("<span style='color:", label_colors[s], "'>", s, "</span>")
      })
    }) +
    theme(axis.text.x = ggtext::element_markdown()),
  tooltip = "text",
  height = 800)
```

#### In hoeveel domeinen komt een soort voor? 
```{r}

```


#### Voorkomen in ANB domeinen vs voorkomen in Vlaanderen

Wat veel aanwezig is in ANB domeinen is veel aanwezig in Vlaanderen? 
```{r patdat-vs-vl, echo=FALSE}
x <- PATDAT %>%
  filter(gebied == "PATDAT" & type == "of") %>%
  left_join(VL, by = c("soort" = "Soort")) %>%
  transmute(soort, species, abbr, ofPATDAT = overlap, ofVL)

ggplot() +
  geom_text(data = x, aes(x = ofVL, y = ofPATDAT, label = abbr)) +
  geom_abline() +
  geom_abline(intercept = c(-0.02,0.02), linetype = 2) +
  coord_equal(ratio = 1) +
  theme_bw()
```

#### Voorkomen van soorten per beheerregio

#### Welke soorten zijn oververtegenwoordigd in ANB domeinen, per beheerregio? Maw voor welke soorten draagt het ANB een grote verantwoordelijkheid? 
```{r inpatdat-vs-invl, echo=FALSE}
aandeel_vl <- am_patdat %>%
  group_by(regio) %>%
  summarise() %>%
  drop_na() %>%
  mutate(ofVL =  as.numeric(st_area(.) / Vlaanderen_grenzen$OPPERVL)) %>%
  st_drop_geometry()

x <- PATDAT %>%
  filter(gebied != "PATDAT" & type == "in") %>%
  mutate(gebied = replace(gebied, gebied == "AntKem", "Antwerpse Kempen"),
         gebied = replace(gebied, gebied == "BraWou", "Brabantse Wouden"), 
         gebied = replace(gebied, gebied == "DemZKe", "Demerland & Zuiderkempen"), 
         gebied = replace(gebied, gebied == "GroGor", "Groene Gordels"),
         gebied = replace(gebied, gebied == "KusWes", "Kust & Westhoek"), 
         gebied = replace(gebied, gebied == "LtHKem", "Lage tot aan Hoge Kempen"), 
         gebied = replace(gebied, gebied == "Taxand", "Taxandria"), 
         gebied = replace(gebied, gebied == "VArSch", "Vlaamse Ardennen & Schelde-Leie"), 
         gebied = replace(gebied, gebied == "ZanVla", "Zandig Vlaanderen"), 
         gebied = replace(gebied, gebied == "HKeVoe", "Hoge Kempen tot Voeren")) %>%
  left_join(aandeel_vl, by = c("gebied" = "regio")) %>%
  mutate(factor = overlap/ofVL) %>%
  filter(!soort %in% unique(spor_species$Soort))

PATDAT_max5 <- x %>%
  filter(overlap != 0) %>%
  group_by(gebied) %>%
  slice_max(order_by = factor, n = 5, na_rm = TRUE)

PATDAT_min5 <- x %>%
  filter(overlap != 0) %>%
  group_by(gebied) %>%
  slice_min(order_by = factor, n = 5, na_rm = TRUE)

PATDAT_slice <- rbind(PATDAT_max5, PATDAT_min5)

for (i in unique(PATDAT_slice$gebied)) {
  df <- PATDAT_slice %>%
    filter(gebied == i) 
  
  print(ggplot() +
          geom_point(data = df, aes(x = factor + 0.0001, y = reorder(soort, factor))) +
          geom_vline(xintercept = 1) +
          coord_trans(x = "log2") +
          labs(title = paste(i)) + 
          xlab("Factor") +
          theme_bw() + 
          theme(axis.title.y = element_blank(), 
                axis.text.y = element_text(size = 10)))
}
```





---
title: "Download GBIF occurrences"
author: "Fleur Petersen"
date: "2023-10-26"
output: html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

Downloading alien species occurrences for Belgium from [GBIF](https://www.gbif.org)

Script based on the [TrIAS species cube workflow provided by Oldoni et al.](https://github.com/trias-project/occ-cube/tree/master)

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r load_libraries}
library(tidyverse)      
library(here)          
library(rgbif)        
library(trias)         
library(lubridate)     
library(sf)
library(vecsets)
```

```{r clear_memory}
rm(list=ls())
```

# Define download query parameters

## Taxa
```{r define_taxa}
taxonKey <- read_csv2("./radius/data/input/radius_species_list.csv") %>%
  pull("GBIF_code") 
```

## Countries
```{r define_countries}
countries <- c("BE")
```

## Basis of record
```{r define_basis_of_record}
basis_of_record <- c(
  "OBSERVATION", 
  "HUMAN_OBSERVATION",
  "MATERIAL_SAMPLE", 
  "LITERATURE", 
  "PRESERVED_SPECIMEN", 
  "UNKNOWN", 
  "MACHINE_OBSERVATION"
)
```

## Year
```{r define_year}
year_begin <- 2015
year_end <- year(Sys.Date())
```

## Geographic coordinates
```{r define_hasCoordinates}
hasCoordinate <- TRUE
```

# Download GBIF occurrences

## Trigger download
```{r gbif_download}
# Trigger new download
#gbif_download_key <- occ_download(
#  pred_in("taxonKey", taxonKey),
#  pred_in("country", countries),
#  pred_in("basisOfRecord", basis_of_record),
#  pred_gte("year", year_begin),
#  pred_lte("year", year_end),
#  pred("hasCoordinate", hasCoordinate),
#  user = rstudioapi::askForPassword("GBIF username"),
#  pwd = rstudioapi::askForPassword("GBIF password"),
#  email = rstudioapi::askForPassword("Email address for notification")
#)

# Or reuse existing download
gbif_download_key <- "0051379-231002084531237"
```

## Get GBIF download to computer
```{r gbif-dataset-to-computer}
occ_raw <- occ_download_get(key = gbif_download_key,
                             path = "./radius/data/input/", overwrite = TRUE)
```

## Get GBIF download into R
```{r gbif-dataset-to-R}
occ_raw <- occ_raw %>%
  occ_download_import()
```

# Filter data

## Define filters on occurrences
```{r define-issues-to-discard}
issues_to_discard <- c(
  "ZERO_COORDINATE",
  "COORDINATE_OUT_OF_RANGE", 
  "COORDINATE_INVALID",
  "COUNTRY_COORDINATE_MISMATCH"
)
```

```{r define-occurrenceStatus-to-discard}
occurrenceStatus_to_discard <- c(
  "ABSENT")
```

```{r define-identificationVerificationStatus-to-discard}
identificationVerificationStatus_to_discard <- c(
  "unverified",
  "not validated", 
  "under validation"
)
```

## Filter occurrences

```{r filter-occurrence-data}
occ_filtered <- occ_raw %>%
  distinct(occurrenceID, .keep_all = TRUE) %>% # get rid of duplicates
  filter(!is.na(decimalLongitude), !is.na(decimalLatitude)) %>% # filter out those without coordinates
  filter(!occurrenceStatus %in% occurrenceStatus_to_discard) %>%  # filter out absence data
  filter(!issue %in% issues_to_discard) %>%   # filter out specified issues
  filter(!identificationVerificationStatus %in% identificationVerificationStatus_to_discard)  # filter out verification status to discard

```

## Filter occurrences for Flanders

```{r make-spatial}
occ_spatial <- st_as_sf(occ_filtered, coords = c("decimalLongitude", "decimalLatitude"),
                 crs = "+proj=longlat +datum=WGS84")
```

```{r map-flanders}
Vlaanderen_grenzen <- st_read("./prius/data/spatial/flanders_wgs84.geojson")
```

```{r filter-occ-flanders}
occ_flanders_spatial <- st_transform(occ_spatial, crs = st_crs(Vlaanderen_grenzen)) %>%
  st_join(Vlaanderen_grenzen) %>%
  filter(!is.na(UIDN))

#remove geometry, replace with lon, lat
occ_flanders <- occ_flanders_spatial %>%
  mutate(decimalLongitude = sf::st_coordinates(.)[,2],
         decimalLatitude = sf::st_coordinates(.)[,1]) %>%
  st_drop_geometry()
```

# Summarise output

## Map taxa to species
Grouping by `speciesKey`, we lose information about which taxa share the same `speciesKey`. This information could be sometimes helpful. We extract it in a separate data.frame, `taxa_species`.

```{r get-distinct-taxa-in-occ-flanders}
occ_flanders_taxa <- occ_flanders %>%
  select(speciesKey, taxonKey, scientificName) %>%
  distinct()
```

Some species have occurrences coming from multiple taxa, synonyms and/or infraspecific taxa:
```{r show-multiple-taxonKey}
occ_flanders_taxa %>%
  group_by(speciesKey) %>%
  count() %>%
  filter(n > 1) %>%
  select(-n) %>%
  left_join(occ_flanders_taxa, by = "speciesKey") %>%
  arrange(speciesKey, taxonKey) %>%
  pull(taxonKey) -> List_multiple_taxonKeys

```

Some species have occurrences only from taxa linked to their infraspecific taxa or synonyms. In these cases `speciesKey` is never equal to `taxonKey`:
```{r show_taxa_speciesKey_not_taxonKey}
occ_flanders_taxa %>%
  group_by(speciesKey) %>%
  count() %>%
  rename(n_taxa = n) %>%
  left_join(occ_flanders_taxa, by = "speciesKey") %>%
  group_by(speciesKey, n_taxa) %>%
  filter(taxonKey != speciesKey) %>%
  count() %>%
  rename(n_taxonKey_not_speciesKey = n) %>%
  filter(n_taxonKey_not_speciesKey == n_taxa) %>%
  left_join(occ_flanders_taxa %>%
              filter(speciesKey != taxonKey),
            by = "speciesKey") %>%
  ungroup() %>%
  select(-c(n_taxa, n_taxonKey_not_speciesKey)) %>%
  arrange(speciesKey, taxonKey)
```

We create `taxa_species` by adding the taxonomic rank, `SPECIES`, and the taxonomic status of the species, one of `ACCEPTED` or `DOUBTFUL`, and create a column called `include` which contains all taxa whose occurrences are linked to the species:
```{r make_taxa_species}
taxa_species <- 
  occ_flanders_taxa %>%
  
  # get unique 'speciesKey'
  distinct(speciesKey) %>%

  # extract speciesKey
  pull(speciesKey) %>%

  # GBIF query via name_usage
  map(~name_usage(key = .x)) %>%

  # Select data
  map(~.x[["data"]]) %>%

  # Merge all taxa in a data.frame
  reduce(full_join) %>%

  # select columns of interest
  select(speciesKey, scientificName, rank, taxonomicStatus, kingdom) %>%
  
  # rename 'scientificName' to 'species_scientificName'
  rename(species_scientificName = scientificName) %>%
  
  # add these columns to original df
  right_join(occ_flanders_taxa, by = "speciesKey") %>%
  
  # group by 'speciesKey'
  group_by(speciesKey,
           species_scientificName,
           rank,
           taxonomicStatus,
           kingdom) %>%
  
  # create 'includes' column
  summarize(includes = paste(
    taxonKey, 
    scientificName, 
    sep = ": ", 
    collapse = " | ")) %>%
  
  # rename 'species_scientificName' to 'scientificName'
  rename(scientificName = species_scientificName)
```

## Comparison radius_species_list and gbif occurrences

## Subset columns to use
```{r subset-columns}
occ_flanders <- occ_flanders %>%
  select(year, month, day, decimalLongitude, decimalLatitude, speciesKey, coordinateUncertaintyInMeters, gbifID) %>%  #following be_species_cube column formatting, can be changed if needed
  arrange(year, month, day, speciesKey)
```

```{r comparison-species-list-gbif-occurrences}
species_list <- read_csv2("./radius/data/input/radius_species_list.csv")

occ_flanders_summary <- occ_flanders %>%
  group_by(speciesKey) %>%
  summarise(unique_obs = n_distinct(gbifID)) %>%
  left_join(species_list, by = c("speciesKey" = "GBIF_code")) %>%
  select(speciesKey, unique_obs)

not_in_flanders <- species_list %>%
  left_join(occ_flanders_summary, by = c("GBIF_code" = "speciesKey")) %>%
  filter(is.na(unique_obs)) %>%
  filter(!GBIF_code %in% List_multiple_taxonKeys) #wegfilteren van synoniemen/subspecies/... die onder speciesKey van aanwezige soorten vallen

in_flanders <- species_list %>%
  left_join(occ_flanders_summary, by = c("GBIF_code" = "speciesKey")) %>%
  filter(!is.na(unique_obs))

List_species_present <- unique(in_flanders$Soort)
List_species_not_present <- vsetdiff(unique(species_list$Soort) , List_species_present)
#write(List_species_present, ".radius/data/output/...")
#write(List_species_not_present, ".radius/data/output/...")
```

## Save occurrence dataset flanders

```{r save-occurrence-dataset}
write.csv2(occ_flanders, "./radius/data/input/gbif_occ_flanders.csv")
```





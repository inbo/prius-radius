---
title: "Preparing species list"
author: "Fleur Petersen"
date: "2023-11-06"
output: html_document
---

Double-checking the GBIF codes for the RadIUS species list
1. comparison to the Union list dataset (Adriaens & Oldoni, 2023)
2. checking if the GBIF codes are still up to date

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries}
library(tidyverse)   
library(rgbif)        
library(trias)
```

```{r clear_memory}
rm(list=ls())
```

# Comparison PrIUS list and Union list

## Get PrIUS species list and Union list
```{r prius_list}
prius_list <- read_csv("./prius/data/input/prius_species_list.csv", locale = locale(encoding = "ISO-8859-1"), show_col_types = FALSE)  
```

```{r union_list}
datasetKey <- "79d65658-526c-4c78-9d24-1870d67f8439" #linked to unionlist dataset ("https://www.gbif.org/dataset/79d65658-526c-4c78-9d24-1870d67f8439")
union_list <- name_usage(datasetKey = datasetKey, limit = 10000)$data %>%
  subset(rank != "KINGDOM") #Animalia, Chromista, Plantae wegfilteren
```

## Small adjustments of species names in both datasets to assure comparability
```{r union_list_adjustments}
union_list$scientificName[union_list$scientificName == "Sciurus carolinensis Gmelin,1788"] <- "Sciurus carolinensis Gmelin, 1788"
union_list$scientificName[union_list$scientificName == "Sciurus niger Linnaeus, 1758"] <- "Sciurus niger L., 1758"
union_list$scientificName[union_list$scientificName == "Nasua nasua Linnaeus, 1766"] <- "Nasua nasua L., 1766"
union_list$scientificName[union_list$scientificName == "Procyon lotor Linnaeus, 1758"] <- "Procyon lotor L., 1758"
union_list$scientificName[union_list$scientificName == "Salvinia molesta D.S. Mitch."] <- "Salvinia molesta D.S.Mitch."
union_list$scientificName[union_list$scientificName == "Lysichiton americanus Hultén and St. John"] <- "Lysichiton americanus Hultén & H. St. John"
```

```{r prius_list_adjustments}
prius_list$Species[prius_list$Species == "Triadica sebífera (L.) Small"] <- "Triadica sebifera (L.) Small"
```

## Update GBIF scientific name in both lists
```{r update-scientific-names}
prius_list$prius_scientificName <- 0

for(i in 1:nrow(prius_list)) {
  name_usage(key = prius_list$GBIF_code[i]) -> temp
  temp$data$scientificName -> prius_list$prius_scientificName[i]
  }

union_list$union_scientificName <- 0

for(i in 1:nrow(union_list)) {
  name_usage(key = union_list$nubKey[i]) -> temp
  temp$data$scientificName -> union_list$union_scientificName[i]
  }
rm(i,temp)
```


## Combining both lists for comparison
```{r joining_species_lists}
full_join(prius_list, union_list, by = c("Species" = "scientificName")) %>%
  transmute(Species, Soort, Lijst, prius_gbif_code = GBIF_code, prius_scientificName, union_gbif_code = nubKey, union_scientificName) %>%
  mutate(
    code_check = if_else(prius_gbif_code == union_gbif_code, "TRUE", "FALSE"),
    prius_name_check = if_else(Species == prius_scientificName, "TRUE", "FALSE")) -> list_check
```

## Check taxonomic status and whether any codes were recently deleted from GBIF
```{r check-taxonomic-status-and-deleted}
# Define a function to check the taxonomicStatus and whether the GBIF code was (recently) deleted
check_status_and_deleted <- function(code_column, status_column, deleted_column) {
  result <- lapply(code_column, function(code) {
    if (is.na(code)) {
      status <- "NA"
      deleted <- "NA"
    } else {
      name_usage(key = code) -> temp
      status <- temp$data$taxonomicStatus
      deleted <- if ("deleted" %in% colnames(temp$data)) "TRUE" else "FALSE"
    }
    return(data.frame(Status = status, Deleted = deleted))
  })
  return(do.call(rbind, result))
}

# Check the status and deleted columns for Prius list
prius_result <- check_status_and_deleted(list_check$prius_gbif_code, "prius_status_check", "prius_deleted")

# Check the status and deleted columns for Union list
union_result <- check_status_and_deleted(list_check$union_gbif_code, "union_status_check", "union_deleted")

# Assign the results back to the data frame
list_check$prius_status_check <- prius_result$Status
list_check$union_status_check <- union_result$Status
list_check$prius_deleted <- prius_result$Deleted
list_check$union_deleted <- union_result$Deleted

# Remove unnecessary variables
rm(prius_result, union_result)
```


## Add issue column that separates different issues
```{r add-issue-column}
list_check <- list_check %>%
  mutate(issue = case_when(code_check == "TRUE" & prius_name_check == "TRUE" ~ "ok",
                           code_check == "TRUE" & prius_name_check == "FALSE" ~ "name_issue",   #name_issue: in prius list Species is not equal to gbif scientific name
                           code_check == "FALSE" & prius_name_check == "TRUE" ~ "code_issue",   #code_issue: gbif codes differ between prius and union list
                           code_check == "FALSE" & prius_name_check == "FALSE" ~ "code_name_issue",   #code_name_issue: combination of two previous issues
                           is.na(code_check) & prius_name_check == "FALSE" ~ "name_issue")) %>%
  arrange(issue)
```

## Reformatting PrIUS list to attain RadIUS list
```{r adjusting-hydrocotyle-ranunculoides-GBIF-code}
radius_list <- prius_list %>%
  mutate(GBIF_code = if_else(GBIF_code == 3034613, 7978544, GBIF_code))
```

# Checking GBIF keys

```{r prius_key_check}
radius_key_check <- gbif_verify_keys(radius_list, col_keys = "GBIF_code") %>%
  full_join(prius_list, by = c("key" = "GBIF_code"))
```
# Export radius list

```{r export-radius-list}
write.csv2(radius_list, "./radius/data/input/radius_species_list.csv")
```


```{r load-packages}
library(sf)
library(tidyverse) 
library(httr)
library(ows4R) 
library(leaflet)
library(gdalUtilities)
library(ggplot2)
```

```{r clear-memory}
rm(list=ls())
```

```{r function-multisurface-to-multipolygon}
ensure_multipolygons <- function(X) {
    tmp1 <- tempfile(fileext = ".gpkg")
    tmp2 <- tempfile(fileext = ".gpkg")
    st_write(X, tmp1)
    ogr2ogr(tmp1, tmp2, f = "GPKG", nlt = "MULTIPOLYGON")
    Y <- st_read(tmp2)
    st_sf(st_drop_geometry(X), geom = st_geometry(Y))
}
```

# Read data into R

```{r import-species-list}
species_list <- read_csv("./radius/data/input/radius_species_list.csv") %>%
  mutate(disp_dist = 250) # Manually set dispersal distance for species (placeholder for replacement with biologically relevant distances)
```

```{r import-species-occ}
occ_flanders <- read.csv2("./radius/data/input/gbif_occ_flanders.csv") %>%
  select(-X) %>%
  left_join(species_list, by = c("speciesKey" = "GBIF_code", "Soort")) %>%
  select(year, decimalLongitude, decimalLatitude, speciesKey, Soort, coordinateUncertaintyInMeters, disp_dist) %>%
  st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), crs = "+proj=longlat +datum=WGS84") %>%
  st_transform(31370) %>%  # st_buffer()/st_union does not correctly buffer longitude-latitude spatial data, whose distance is assumed to be in decimal degrees (arc_degrees).We transform the EPSG:4326 to Lambert 72.
  filter(Soort %in% c("watercrassula", "kleine waterteunisbloem", "heilige ibis", "Chinese muntjak", "hemelboom"))
```

```{r boundaries-flanders}
Vlaanderen_grenzen <- st_read("./prius/data/spatial/flanders_wgs84.geojson")
Provincies_grenzen <- st_read("./prius/data/spatial/Provincies.geojson")
```

# Habitatrichtlijndeelgebieden (ps:ps_hbtrl_deel)

```{r get-ps-hbtrl-deel}
wfs_ANB <- "https://www.mercator.vlaanderen.be/raadpleegdienstenmercatorpubliek/wfs"

#generate URL for WFS download
url <- parse_url(wfs_ANB)
url$query <- list(service = "WFS",
                  version = "2.0.0", 
                  request = "GetFeature",
                  typename = "ps:ps_hbtrl_deel")
request <- build_url(url)

ps_hbtrl_deel <- read_sf(request) %>%
  st_set_crs(31370) %>%  # omzetten naar Lambert72
  ensure_multipolygons()   # multisurface to multipolygon
```

```{r quick-visual-check}
ggplot() + geom_sf(data = ps_hbtrl_deel, aes(color = gebcode))
```

# Vogelrichtlijngebieden (ps:ps_vglrl)

```{r get-ps-vgrl}
url <- parse_url(wfs_ANB)
url$query <- list(service = "WFS",
                  version = "2.0.0", 
                  request = "GetFeature",
                  typename = "ps:ps_vglrl")
request <- build_url(url)

ps_vglrl <- read_sf(request) %>%
  st_set_crs(31370) %>%  
  ensure_multipolygons()   
```

```{r quick-visual-check}
ggplot() + geom_sf(data = ps_vglrl, aes(color = na2000code))
```

# Biologische waarderingskaart (BWK:Bwkhab)

## wegens max.van 10.000 features bij inladen WFS,laadt ik de BWK/Natura2000 Habitatkaart in als shapefile

```{r import-shapefile-bwkhab}
bwkhab <- st_read("./radius/data/spatial/BwkHab.shp") %>%
  st_transform(31370)

# aanpassing bwk/n2000 habitatkaart voor gebruik in RadIUS
bwkhab_adj <- bwkhab %>% 
  mutate(HAB1 = str_sub(bwkhab$HAB1, 1, 4)) %>%  # only retain the first part of the HAB1 string
  group_by(HAB1) %>%                             # summarise df to retain one line per HAB1 value
  summarise() %>%                                    
  filter(grepl('^[0-9]', HAB1))                  # remove non-n2000 habitats
```

```{r quick-visual-check}
ggplot() + geom_sf(data = bwkhab_adj)
```

# ANB Patrimonium databank (am:am_patdat)

```{r ANB patrimonium databank (am:am_patdat)}
url <- parse_url(wfs_ANB)
url$query <- list(service = "WFS",
                  version = "2.0.0", 
                  request = "GetFeature",
                  typename = "am:am_patdat")
request <- build_url(url)

am_patdat <- read_sf(request) %>%
  st_set_crs(31370) %>%  
  ensure_multipolygons()   
```

```{r quick-visual-check}
ggplot() + geom_sf(data = am_patdat, aes(color = regio))
# Oppassen : er (b)lijken enkel NA's onder regio te zitten?
```

# Add columns with abbreviations
```{r}
am_patdat <- am_patdat %>%
  mutate(rechtenanb_abb = case_when(
    rechtenanb == "Technisch beheer conform bosdecreet" ~ "Bosdec",
    rechtenanb == "Eigendom" ~ "Eigend",
    rechtenanb == "Huur" ~ "Huur",
    rechtenanb == "Beheerovereenkomst" ~ "BehOve",
    rechtenanb == "Protocol landsverdediging" ~ "ProLan",
    rechtenanb == "Erfpacht" ~ "Erfpac")) %>%
  mutate(regio_abb = case_when(
    regio == "Antwerpse Kempen" ~ "AntKem",
    regio == "Hoge Kempen tot Voeren" ~ "HKeVoe",
    regio == "Groene Gordels" ~ "GroGor",
    regio == "Brabantse Wouden" ~ "BraWou",
    regio == "Demerland & Zuiderkempen" ~ "DemZKe",
    regio == "Vlaamse Ardennen & Schelde-Leie" ~ "VArSch",
    regio == "Kust & Westhoek" ~ "KusWes",
    regio == "Taxandria" ~ "Taxand",
    regio == "Lage tot aan Hoge Kempen" ~ "LtHKem",
    regio == "Zandig Vlaanderen" ~ "ZanVla",
  ))
```


# Natuurbeheerplannen (ps:ps_nbhp)

```{r get-ps-nbhp}
url <- parse_url(wfs_ANB)
url$query <- list(service = "WFS",
                  version = "2.0.0", 
                  request = "GetFeature",
                  typename = "ps:ps_nbhp")
request <- build_url(url)

ps_nbhp <- read_sf(request) %>%
  st_set_crs(31370) %>%  
  ensure_multipolygons()   
```

```{r quick-visual-check}
ggplot() + geom_sf(data = ps_nbhp)
```

# Calculating occupancy metrics in protected areas
```{r}
# list wfs-maps
list.dfs <- list(
  HBTRL = ps_hbtrl_deel,
  VGLRL = ps_vglrl,
  BWKHAB = bwkhab_adj,
  PATDAT = am_patdat
  )

# per wfs-map, one output dataframe with results
list.results <- list(
  HBTRL = data.frame(),
  VGLRL = data.frame(),
  BWKHAB = data.frame(),
  PATDAT = data.frame()
  )

for (soort in unique(occ_flanders$Soort)) {
  print(soort)
  
  # extract species occurrence
  occ_species <- occ_flanders[occ_flanders$Soort == soort,]
  disp_dist <- unique(occ_species$disp_dist)
  
  # add buffer around species occurrences based on dispersal distance + union
  occ_species_buf <- occ_species %>%
    st_buffer(dist = disp_dist) %>%
    st_union() %>% 
    st_cast('POLYGON') %>% 
    st_sf() %>%
    mutate(buf_area = st_area(.))
  
  total_area <- sum(occ_species_buf$buf_area)
  
  # loop through wfs-maps to calculate occupancy metrics
  for (i in 1:length(list.dfs)) {
    
    # transform crs to Lambert 72 to use st_buffer with metres instead of decimal degrees. 
    gebied <- list.dfs[[i]] %>%
      st_transform(31370) %>%
      mutate(geb_area = st_area(.))
    
    # intersection buffered occurrences with wfs-map
    occ_species_intersection <- occ_species_buf %>%
      st_intersection(gebied) %>% 
      mutate(intersect_area = st_area(.)) 
    
    overlap_intersection <- sum(occ_species_intersection$intersect_area)
    percentage_overlap_in <- as.numeric(sum(occ_species_intersection$intersect_area)/total_area)
    percentage_overlap_of <- as.numeric(sum(occ_species_intersection$intersect_area)/sum(gebied$geb_area))
    
    # occupancy metrics for HBTRL (i = 1) and VGLRL (i = 2)
    if (i %in% c(1, 2)) {
      list.results[[i]] <- rbind(list.results[[i]], data.frame(
        Soort = soort,
        Gebied = paste0("in", names(list.dfs)[i]),
        Percentage_Overlap = format(round(percentage_overlap_in, 3))))
      
      list.results[[i]] <- rbind(list.results[[i]], data.frame(
        Soort = soort,
        Gebied = paste0("of", names(list.dfs)[i]),
        Percentage_Overlap = format(round(percentage_overlap_of, 3))))
      
      overlap_per_gebied <- occ_species_intersection %>%
        group_by(code = if (i == 2) na2000code else gebcode) %>%
        summarise(intersect_area = sum(intersect_area)) %>%
        st_drop_geometry() 
      
      for (row in 1:nrow(overlap_per_gebied)) {
        percentage_overlap_in = as.numeric(overlap_per_gebied[row,]$intersect_area / total_area)
        
        list.results[[i]] <- rbind(list.results[[i]], data.frame(
          Soort = soort,
          Gebied = paste0("in", as.character(overlap_per_gebied[row,1])),
          Percentage_Overlap = format(round(percentage_overlap_in, 3))))
          
        percentage_overlap_of = as.numeric(overlap_per_gebied[row,]$intersect_area / sum(gebied$geb_area))
        
        list.results[[i]] <- rbind(list.results[[i]], data.frame(
          Soort = soort,
          Gebied = paste0("of", as.character(overlap_per_gebied[row,1])),
          Percentage_Overlap = format(round(percentage_overlap_of, 3))))
      }
    }
    
    # occupancy metrics for BWKHAB (i = 3)
    if (i == 3) {
      list.results[[i]] <- rbind(list.results[[i]], data.frame(
        Soort = soort,
        Gebied = paste0("in", names(list.dfs)[i]),
        Percentage_Overlap = format(round(percentage_overlap_in, 3))))
      
      list.results[[i]] <- rbind(list.results[[i]], data.frame(
        Soort = soort,
        Gebied = paste0("of", names(list.dfs)[i]),
        Percentage_Overlap = format(round(percentage_overlap_of, 3))))
      
      overlap_per_gebied <- occ_species_intersection %>%
        group_by(code = HAB1) %>%
        summarise(intersect_area = sum(intersect_area)) %>%
        st_drop_geometry() 
      
      for (row in 1:nrow(overlap_per_gebied)) {
        percentage_overlap_in = as.numeric(overlap_per_gebied[row,]$intersect_area / total_area)
        
        list.results[[i]] <- rbind(list.results[[i]], data.frame(
          Soort = soort,
          Gebied = paste0("inHAB", as.character(overlap_per_gebied[row,1])),
          Percentage_Overlap = format(round(percentage_overlap_in, 3))))
          
        percentage_overlap_of = as.numeric(overlap_per_gebied[row,]$intersect_area / sum(gebied$geb_area))
        
        list.results[[i]] <- rbind(list.results[[i]], data.frame(
          Soort = soort,
          Gebied = paste0("ofHAB", as.character(overlap_per_gebied[row,1])),
          Percentage_Overlap = format(round(percentage_overlap_of, 3))))
      }
    }
    
    # occupancy metrics for PATDAT (i = 4)
    if (i == 4) {
      # totaal aantal domeinen (nDomeinen)
      list.results[[i]] <- rbind(list.results[[i]], data.frame(
          Soort = soort,
          Gebied = "nDomeinen",
          Value = length(unique(occ_species_intersection$domeinnaam))))
      
      # aantal bezette domeinen per type recht anb
      anb_rechten <- occ_species_intersection %>%
        group_by(rechtenanb_abb) %>%
        summarise(n = n()) %>%
        st_drop_geometry()
      
      for (row in 1:nrow(anb_rechten)) {
        list.results[[i]] <- rbind(list.results[[i]], data.frame(
          Soort = soort,
          Gebied = paste0("n", as.character(anb_rechten[row,1])),
          Value = as.character(anb_rechten[row,2])))
      }
      
      # percentage overlap met anb domeinen (inANB)
      list.results[[i]] <- rbind(list.results[[i]], data.frame(
        Soort = soort,
        Gebied = paste0("in", names(list.dfs)[i]),
        Value = format(round(percentage_overlap_in, 3))))
      
      list.results[[i]] <- rbind(list.results[[i]], data.frame(
        Soort = soort,
        Gebied = paste0("of", names(list.dfs)[i]),
        Value = format(round(percentage_overlap_of, 3))))
      
      
      # percentage overlap per anb regio
      overlap_per_anb_regio <- occ_species_intersection %>%
        group_by(regio_abb) %>%
        summarise(intersect_area = sum(intersect_area)) %>%
        arrange() %>%
        st_drop_geometry()
      
      for (row in 1: nrow(overlap_per_anb_regio)) {
        percentage_overlap_in = as.numeric(overlap_per_anb_regio[row,]$intersect_area / total_area)
        
        list.results[[i]] <- rbind(list.results[[i]], data.frame(
          Soort = soort,
          Gebied = paste0("in", as.character(overlap_per_anb_regio[row,1])),
          Value = format(round(percentage_overlap_in, 3))))
          
        percentage_overlap_of = as.numeric(overlap_per_anb_regio[row,]$intersect_area / sum(gebied$geb_area))
        
        list.results[[i]] <- rbind(list.results[[i]], data.frame(
          Soort = soort,
          Gebied = paste0("of", as.character(overlap_per_anb_regio[row,1])),
          Value = format(round(percentage_overlap_of, 3))))
        }
    }
  }    
}
```

# Adjust column format from long to wide
```{r}
HBTRL <- list.results$HBTRL %>%
  pivot_wider(names_from = Gebied, values_from = Percentage_Overlap, values_fill = "0")

VGLRL <- list.results$VGLRL %>%
  pivot_wider(names_from = Gebied, values_from = Percentage_Overlap, values_fill = "0")

BWKHAB <- list.results$BWKHAB %>%
  pivot_wider(names_from = Gebied, values_from = Percentage_Overlap, values_fill = "0")

PATDAT <- list.results$PATDAT %>%
  pivot_wider(names_from = Gebied, values_from = Value, values_fill = "0")
```

```{r save-list-results-as-RData-file}
saveRDS(list.results, file="./radius/data/output/list_results.RData")
```
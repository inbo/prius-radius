```{r load-packages}
library(sf)
library(tidyverse) 
library(httr)
library(ows4R) 
library(leaflet)
library(gdalUtilities)
library(ggplot2)
```

```{r clear-memory}
rm(list=ls())
```

```{r function-multisurface-to-multipolygon}
ensure_multipolygons <- function(X) {
    tmp1 <- tempfile(fileext = ".gpkg")
    tmp2 <- tempfile(fileext = ".gpkg")
    st_write(X, tmp1)
    ogr2ogr(tmp1, tmp2, f = "GPKG", nlt = "MULTIPOLYGON")
    Y <- st_read(tmp2)
    st_sf(st_drop_geometry(X), geom = st_geometry(Y))
}
```

# Read data into R

```{r import-species-list}
species_list <- read_csv("./radius/data/input/radius_species_list.csv") %>%
  mutate(disp_dist = 250) # Manually set dispersal distance for species (placeholder for replacement with biologically relevant distances)
```

```{r import-species-occ}
occ_flanders <- read.csv2("./radius/data/input/gbif_occ_flanders.csv") %>%
  select(-X) %>%
  left_join(species_list, by = c("speciesKey" = "GBIF_code", "Soort")) %>%
  select(year, decimalLongitude, decimalLatitude, speciesKey, Soort, coordinateUncertaintyInMeters, disp_dist) %>%
  st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), crs = "+proj=longlat +datum=WGS84") %>%
  st_transform(31370) %>%  # st_buffer()/st_union does not correctly buffer longitude-latitude spatial data, whose distance is assumed to be in decimal degrees (arc_degrees).We transform the EPSG:4326 to Lambert 72.
  filter(Soort %in% c("watercrassula", "kleine waterteunisbloem", "heilige ibis", "Chinese muntjak", "hemelboom"))
```

```{r boundaries-flanders}
Vlaanderen_grenzen <- st_read("./prius/data/spatial/flanders_wgs84.geojson")
Provincies_grenzen <- st_read("./prius/data/spatial/Provincies.geojson")
```

# Habitatrichtlijndeelgebieden (ps:ps_hbtrl_deel)

```{r get-ps-hbtrl-deel}
wfs_ANB <- "https://www.mercator.vlaanderen.be/raadpleegdienstenmercatorpubliek/wfs"

#generate URL for WFS download
url <- parse_url(wfs_ANB)
url$query <- list(service = "WFS",
                  version = "2.0.0", 
                  request = "GetFeature",
                  typename = "ps:ps_hbtrl_deel")
request <- build_url(url)

ps_hbtrl_deel <- read_sf(request) %>%
  st_set_crs(31370) %>%  # omzetten naar Lambert72
  ensure_multipolygons()   # multisurface to multipolygon
```

```{r quick-visual-check}
ggplot() + geom_sf(data = ps_hbtrl_deel, aes(color = gebcode))
```

# Vogelrichtlijngebieden (ps:ps_vglrl)

```{r get-ps-vgrl}
url <- parse_url(wfs_ANB)
url$query <- list(service = "WFS",
                  version = "2.0.0", 
                  request = "GetFeature",
                  typename = "ps:ps_vglrl")
request <- build_url(url)

ps_vglrl <- read_sf(request) %>%
  st_set_crs(31370) %>%  
  ensure_multipolygons()   
```

```{r quick-visual-check}
ggplot() + geom_sf(data = ps_vglrl, aes(color = na2000code))
```

# Biologische waarderingskaart (BWK:Bwkhab)

## wegens max.van 10.000 features bij inladen WFS,laadt ik de BWK/Natura2000 Habitatkaart in als shapefile

```{r import-shapefile-bwkhab}
bwkhab <- st_read("./radius/data/spatial/BwkHab.shp") %>%
  st_transform(31370)

# aanpassing bwk/n2000 habitatkaart voor gebruik in RadIUS
bwkhab_adj <- bwkhab %>% 
  mutate(HAB1 = str_sub(bwkhab$HAB1, 1, 4)) %>%  # only retain the first part of the HAB1 string
  group_by(HAB1) %>%                             # summarise df to retain one line per HAB1 value
  summarise() %>%                                    
  filter(grepl('^[0-9]', HAB1))                  # remove non-n2000 habitats
```

```{r quick-visual-check}
ggplot() + geom_sf(data = bwkhab_adj)
```

# ANB Patrimonium databank (am:am_patdat)

```{r ANB patrimonium databank (am:am_patdat)}
url <- parse_url(wfs_ANB)
url$query <- list(service = "WFS",
                  version = "2.0.0", 
                  request = "GetFeature",
                  typename = "am:am_patdat")
request <- build_url(url)

am_patdat <- read_sf(request) %>%
  st_set_crs(31370) %>%  
  ensure_multipolygons()   
```

```{r quick-visual-check}
ggplot() + geom_sf(data = am_patdat, aes(color = regio))
# Oppassen : er (b)lijken enkel NA's onder regio te zitten?
```

# Natuurbeheerplannen (ps:ps_nbhp)

```{r get-ps-nbhp}
url <- parse_url(wfs_ANB)
url$query <- list(service = "WFS",
                  version = "2.0.0", 
                  request = "GetFeature",
                  typename = "ps:ps_nbhp")
request <- build_url(url)

ps_nbhp <- read_sf(request) %>%
  st_set_crs(31370) %>%  
  ensure_multipolygons()   
```

```{r quick-visual-check}
ggplot() + geom_sf(data = ps_nbhp)
```

# Calculation occurrence metrics in protected areas

```{r}
# list van wfs-datasets
list.dfs <- list(
  "Habitatrichtlijn gebieden" = ps_hbtrl_deel,
  "Vogelrichtlijn gebieden" = ps_vglrl,
  "Natuurbeheerplan gebieden" = ps_nbhp,
  "ANB Patrimonium databank" = am_patdat,
  "BWK/Natura2000 habitats" = bwkhab_adj
)

# We slaan resultaten op in een list van afzonderlijke dataframes
list.results <- list(
  overlap_totaal = data.frame(), 
  overlap_hbtrl_gebieden = data.frame(), 
  overlap_vglrl_gebieden = data.frame(), 
  overlap_nbhp_gebieden = data.frame(), 
  overlap_patdat_gebieden = data.frame(), 
  overlap_bwk_n2000_gebieden = data.frame(), 
  overlap_nbhp_type = data.frame(), 
  overlap_anb_regio = data.frame(), 
  overlap_anb_rechten = data.frame(), 
  overlap_nbhp_eigendom = data.frame()
)

# Loop through species
for (soort in unique(occ_flanders$Soort)) {
  print(soort)
  
  #extract species occurrence
  occ_species <- occ_flanders[occ_flanders$Soort == soort,]
  disp_dist <- unique(occ_species$disp_dist)
  
  # Creëer een buffer rond soortwaarnemingen op basis van dispersieafstand + union tot puntenwolk
  occ_species_buf <- occ_species %>%
    st_buffer(dist = disp_dist) %>%
    st_union() %>% 
    st_cast('POLYGON') %>% 
    st_sf() %>%
    mutate(area = st_area(.))
  
  total_area <- sum(occ_species_buf$area)
  
  print(paste("Totale oppervlakte: ", format(round(total_area, 2))))

  # Loop door wfs-datasets voor berekening van de metrics
  for (i in 1:length(list.dfs)) {
    
    # Transformatie naar Lambert 72 om st_buffer te gebruiken met meter i.p.v. decimal degrees. 
    gebied <- list.dfs[[i]] %>%
      st_transform(31370) 

    occ_species_buf <- occ_species_buf %>%
        st_transform(31370)
    
    # Intersection tussen waarnemingsgegevens en wfs-data
    occ_species_intersection <- occ_species_buf %>%
      st_intersection(gebied) %>% 
      mutate(intersect_area = st_area(.)) %>%
      st_transform(31370)
    
    overlap_intersection <- sum(occ_species_intersection$intersection_oppervlakte)
    percentage_overlap = as.numeric(sum(occ_species_intersection$intersect_area)/total_area)
    
    print(paste("Totale oppervlakte die overlapt met ", names(list.dfs)[i], " = ", format(round(overlap_intersection, 3)), "m²"))
    print(paste("Percentage van totale oppervlakte die overlapt met", names(list.dfs)[i], " = ", format(round(percentage_overlap, 3))))
    
    # Deze overall metrics worden opgeslagen in het eerste dataframe (list.results[[1]]) van de list.results
    list.results[[1]] <- rbind(list.results[[1]], data.frame(
      Soort = soort,
      Gebiedstype = names(list.dfs)[i],
      Percentage_Overlap = percentage_overlap))
    
    # Bereken het overlap percentage per gebied 
    overlap_per_gebied <- occ_species_intersection %>%
      group_by(naam = if (i == 2) gebnaam else if (i == 3) naamdossier else if (i == 4) domeinnaam else if (i == 5) HAB1 else naam) %>%
      summarise(intersect_area = sum(intersect_area)) 
    
    # bij alle gebieden (habitatrichtlijn, vogelrichtlijn, natuurbeheerplannen, ANB patrimoniumdatabank), behalve habitatkaart (i = 5), selecteren we alleen de top 3 gebieden
    if (i != 5) {
      overlap_per_gebied <- overlap_per_gebied %>%
        slice_max(order_by = intersect_area, n = 3, na_rm = TRUE) %>%
        st_drop_geometry()
    }

    print(paste("Top 5 ", names(list.dfs)[i], "en percentage overlap:"))
    
    for (row in 1:nrow(overlap_per_gebied)) {
      percentage_overlap = as.numeric(overlap_per_gebied[row,]$intersect_area / total_area)
      print(paste(row, ". ", overlap_per_gebied[row,]$naam, ": ", format(round(percentage_overlap, 3))))
      
      # We slaan deze top 3 resultaten op in de list.results
      list.results[[i + 1]] <- rbind(list.results[[i + 1]], data.frame(
        Soort = soort,
        gebied = overlap_per_gebied[row,1],
        Percentage_Overlap = percentage_overlap))
    }
    
    # Extra verwerking voor specifieke gevallen
    
    # Voor natuurbeheerplannen (i = 3) kijken we ook naar beheerplantype en eigendomstype
    if (i == 3) {
      for (j in c(6,9)) {
        overlap_nbhp <- occ_species_intersection %>%
          group_by(across(j)) %>%
          summarise(intersect_area = sum(intersect_area)) %>%
          arrange() %>%
          st_drop_geometry()
        
        print(paste("Percentage overlap per", names(overlap_nbhp)[1], ":"))
        for (row in 1: nrow(overlap_nbhp)) {
          percentage_overlap = as.numeric(overlap_nbhp[row,]$intersect_area / total_area)
          
          print(paste(row, ". ", overlap_nbhp[row,1], ": ", format(round(percentage_overlap, 3))))
          
          list.results[[j + 1]] <- rbind(list.results[[j + 1]], data.frame(
            Soort = soort,
            Gebied = overlap_nbhp[row,1],
            Percentage_Overlap = percentage_overlap))
        }
      }
    }
    
    # Voor ANB patrimonium databank (i = 4) kijken we ook naar de afzonderlijke regio's en de verschillende anb rechten
    if (i == 4) {
      for (j in c(6,7)) {
        overlap_patdat <- occ_species_intersection %>%
          group_by(across(j)) %>%
          summarise(intersect_area = sum(intersect_area)) %>%
          arrange() %>%
          st_drop_geometry()
        
        print(paste("Percentage overlap per", names(overlap_patdat)[1], ":"))
        for (row in 1: nrow(overlap_patdat)) {
          percentage_overlap = as.numeric(overlap_patdat[row,]$intersect_area / total_area)
          print(paste(row, ". ", overlap_patdat[row,1], ": ", format(round(percentage_overlap, 3))))
          
          list.results[[j + 2]] <- rbind(list.results[[j + 2]], data.frame(
            Soort = soort,
            gebied = overlap_patdat[row,1],
            Percentage_Overlap = percentage_overlap))
        }
      }
    }
    
    gebied <- gebied %>%
        st_transform(4326)
      
    occ_species_buf <- occ_species_buf %>%
        st_transform(4326)
      
    occ_species_intersection <- occ_species_intersection %>%
        st_transform(4326)
    
    occ_species <- occ_species %>%
        st_transform(4326)
    
    #print(leaflet() %>%
    #        addTiles() %>%
    #        addPolygons(data = gebied, color = "green") %>%
    #        addPolygons(data = occ_species_buf, color = "blue", label = ~area) %>%
    #        addPolygons(data = occ_species_intersection, color = "red", label = ~intersect_area) %>%
    #        addCircleMarkers(data = occ_species, color = "black", radius = 1, fillOpacity = 1, fillColor = "black") %>%
    #        addControl(paste("<P><b>Soort: ", soort, "</b><br/>Gebied: ", i, "<br/>") ,position = 'topright'))
    
  }
}

```

```{r save-list-results-as-RData-file}
saveRDS(list.results, file="./radius/data/output/list_results.RData")
```